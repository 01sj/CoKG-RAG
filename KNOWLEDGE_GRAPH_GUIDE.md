# çŸ¥è¯†å›¾è°±æ„å»ºä¸æŸ¥è¯¢æµç¨‹è¯´æ˜

## ğŸ“‹ ç›®å½•
1. [çŸ¥è¯†å›¾è°±æ„å»ºæµç¨‹](#çŸ¥è¯†å›¾è°±æ„å»ºæµç¨‹)
2. [æ•°æ®å­˜å‚¨æ¶æ„](#æ•°æ®å­˜å‚¨æ¶æ„)
3. [æŸ¥è¯¢æµç¨‹](#æŸ¥è¯¢æµç¨‹)
4. [å…³é”®æ–‡ä»¶è¯´æ˜](#å…³é”®æ–‡ä»¶è¯´æ˜)

---

## ğŸ”¨ çŸ¥è¯†å›¾è°±æ„å»ºæµç¨‹

### é˜¶æ®µ1: æ–‡æœ¬åˆ†å— (Text Chunking)
**è„šæœ¬**: `law_data_chunk.py`

**åŠŸèƒ½**:
- è¯»å–æ³•å¾‹æ–‡æ¡£ï¼ˆJSONæ ¼å¼ï¼‰
- å°†é•¿æ–‡æ¡£åˆ‡åˆ†æˆè¾ƒå°çš„æ–‡æœ¬å—ï¼ˆchunksï¼‰
- æ¯ä¸ªchunkåŒ…å«ï¼š`hash_code`ï¼ˆå”¯ä¸€æ ‡è¯†ï¼‰ã€`text`ï¼ˆæ–‡æœ¬å†…å®¹ï¼‰ã€`metadata`ï¼ˆå…ƒæ•°æ®ï¼‰

**è¾“å‡º**: 
- `datasets/chunks/*_chunk.json` - åˆ†å—åçš„JSONæ–‡ä»¶

---

### é˜¶æ®µ2: å®ä½“å’Œå…³ç³»æå– (Entity & Relation Extraction)
**è„šæœ¬**: `GraphExtraction/law_extract_graphrag.py`

**åŠŸèƒ½**:
- ä½¿ç”¨ vLLM æ¨¡å‹ï¼ˆDeepSeek-V2-Lite-Chatï¼‰ä»æ–‡æœ¬å—ä¸­æå–ï¼š
  - **å®ä½“ï¼ˆEntitiesï¼‰**: æ³•å¾‹æ¦‚å¿µã€æ¡æ¬¾ã€æœºæ„ç­‰
  - **å…³ç³»ï¼ˆRelationsï¼‰**: å®ä½“ä¹‹é—´çš„å…³è”å…³ç³»

**å¤„ç†æµç¨‹**:
```python
# 1. è¯»å–æ‰€æœ‰åˆ†å—æ–‡ä»¶
chunk_files = get_chunk_files(input_path)  # æ”¯æŒå•ä¸ªæ–‡ä»¶æˆ–æ–‡ä»¶å¤¹

# 2. åˆå¹¶æ‰€æœ‰chunksï¼ˆå»é‡ï¼‰
all_chunks = merge_chunks(chunk_files)

# 3. ä½¿ç”¨LLMæå–å®ä½“å’Œå…³ç³»
triple_extraction(all_chunks, llm_func, output_dir)
```

**è¾“å‡º**:
- `law_kg_output_v2/entity.jsonl` - å®ä½“åˆ—è¡¨ï¼ˆJSONLæ ¼å¼ï¼‰
- `law_kg_output_v2/relation.jsonl` - å…³ç³»åˆ—è¡¨ï¼ˆJSONLæ ¼å¼ï¼‰

**å®ä½“æ ¼å¼ç¤ºä¾‹**:
```json
{
  "entity_name": "åŠ³åŠ¨åˆåŒ",
  "description": "åŠ³åŠ¨è€…ä¸ç”¨äººå•ä½ç¡®ç«‹åŠ³åŠ¨å…³ç³»...",
  "entity_type": "æ³•å¾‹æ¦‚å¿µ",
  "source_id": "chunk_hash_1|chunk_hash_2"
}
```

**å…³ç³»æ ¼å¼ç¤ºä¾‹**:
```json
{
  "head": "åŠ³åŠ¨è€…",
  "relation": "ç­¾è®¢",
  "tail": "åŠ³åŠ¨åˆåŒ",
  "description": "åŠ³åŠ¨è€…ä¸ç”¨äººå•ä½ç­¾è®¢åŠ³åŠ¨åˆåŒ..."
}
```

---

### é˜¶æ®µ3: å±‚æ¬¡èšç±»ä¸å›¾è°±æ„å»º (Hierarchical Clustering)
**è„šæœ¬**: `build_law_graph.py` æˆ– `build_graph.py`

**åŠŸèƒ½**:
1. **å®ä½“åµŒå…¥ï¼ˆEmbeddingï¼‰**
   - ä½¿ç”¨ `BAAI/bge-m3` æ¨¡å‹å°†å®ä½“æè¿°è½¬æ¢ä¸ºå‘é‡
   - å‘é‡ç»´åº¦ï¼š1024

2. **å±‚æ¬¡èšç±»ï¼ˆHierarchical Clusteringï¼‰**
   - å°†ç›¸ä¼¼å®ä½“èšåˆæˆæ›´é«˜å±‚æ¬¡çš„èŠ‚ç‚¹
   - æ„å»ºå¤šå±‚æ¬¡çš„å®ä½“æ ‘ç»“æ„
   - ç”Ÿæˆç¤¾åŒºï¼ˆCommunityï¼‰ä¿¡æ¯

3. **å…³ç³»ç”Ÿæˆï¼ˆRelation Generationï¼‰**
   - åŸºäºèšç±»ç»“æœç”Ÿæˆèšåˆå±‚çš„å…³ç³»
   - è®¡ç®—å…³ç³»æƒé‡

**è¾“å‡º**:
- `all_entities.json` - æ‰€æœ‰å±‚çº§çš„å®ä½“ï¼ˆåŒ…å«å‘é‡ï¼‰
- `generate_relations.json` - ç”Ÿæˆçš„å…³ç³»
- `community.json` - ç¤¾åŒºä¿¡æ¯

---

## ğŸ’¾ æ•°æ®å­˜å‚¨æ¶æ„

### 1. å‘é‡æ•°æ®åº“ï¼ˆMilvusï¼‰- ç”¨äºè¯­ä¹‰æ£€ç´¢

**å­˜å‚¨ä½ç½®**: `{working_dir}/milvus_demo.db`

**å­˜å‚¨å†…å®¹**:
- **å®ä½“å‘é‡**: æ‰€æœ‰å±‚çº§çš„å®ä½“åŠå…¶å‘é‡è¡¨ç¤º
- **Collectionåç§°**: `entity_collection`

**æ•°æ®ç»“æ„**:
```python
{
  "id": 0,                    # è‡ªå¢ID
  "entity_name": "åŠ³åŠ¨åˆåŒ",  # å®ä½“åç§°
  "description": "...",        # å®ä½“æè¿°
  "vector": [0.1, 0.2, ...],  # 1024ç»´å‘é‡
  "level": 0,                 # å±‚çº§ï¼ˆ0=åŸå§‹èŠ‚ç‚¹ï¼Œ>0=èšåˆèŠ‚ç‚¹ï¼‰
  "parent": "root",           # çˆ¶èŠ‚ç‚¹
  "source_id": "...",         # æ¥æºchunk IDs
  "degree": 5                 # åº¦æ•°ï¼ˆè¿æ¥æ•°ï¼‰
}
```

**ç”¨é€”**: 
- å¿«é€Ÿè¯­ä¹‰æ£€ç´¢ï¼ˆTop-Kç›¸ä¼¼å®ä½“ï¼‰
- æ”¯æŒæŒ‰å±‚çº§è¿‡æ»¤ï¼ˆlevel_mode: 0/1/2ï¼‰

**æ„å»ºå‡½æ•°**: `database_utils.py::build_vector_search()`

---

### 2. MySQLæ•°æ®åº“ - ç”¨äºç»“æ„åŒ–æŸ¥è¯¢

**æ•°æ®åº“å**: åŸºäº `working_dir` çš„basenameï¼ˆå¦‚ `law_kg_output_v2`ï¼‰

**è¡¨ç»“æ„**:

#### è¡¨1: `entities` - å®ä½“è¡¨
```sql
CREATE TABLE entities (
  entity_name VARCHAR(500),      -- å®ä½“åç§°
  description VARCHAR(10000),   -- å®ä½“æè¿°
  source_id VARCHAR(1000),      -- æ¥æºchunk IDsï¼ˆç”¨|åˆ†éš”ï¼‰
  degree INT,                    -- åº¦æ•°ï¼ˆè¿æ¥æ•°ï¼‰
  parent VARCHAR(1000),         -- çˆ¶èŠ‚ç‚¹
  level INT,                     -- å±‚çº§
  INDEX en(entity_name)          -- ç´¢å¼•
);
```

**å­˜å‚¨å†…å®¹**: æ‰€æœ‰å±‚çº§çš„å®ä½“ä¿¡æ¯ï¼ˆä¸å«å‘é‡ï¼‰

---

#### è¡¨2: `relations` - å…³ç³»è¡¨
```sql
CREATE TABLE relations (
  src_tgt VARCHAR(190),         -- æº->ç›®æ ‡ï¼ˆç»„åˆé”®ï¼‰
  tgt_src VARCHAR(190),         -- ç›®æ ‡->æºï¼ˆç»„åˆé”®ï¼‰
  description VARCHAR(10000),   -- å…³ç³»æè¿°
  weight INT,                    -- å…³ç³»æƒé‡
  level INT,                     -- å±‚çº§
  INDEX link(src_tgt, tgt_src)   -- ç´¢å¼•
);
```

**å­˜å‚¨å†…å®¹**: æ‰€æœ‰å±‚çº§çš„å…³ç³»ä¿¡æ¯

---

#### è¡¨3: `communities` - ç¤¾åŒºè¡¨
```sql
CREATE TABLE communities (
  entity_name VARCHAR(500),      -- ç¤¾åŒº/èšåˆèŠ‚ç‚¹åç§°
  entity_description VARCHAR(10000),  -- ç¤¾åŒºæè¿°
  findings TEXT,                  -- ç¤¾åŒºå‘ç°/æ€»ç»“
  INDEX en(entity_name)          -- ç´¢å¼•
);
```

**å­˜å‚¨å†…å®¹**: ç¤¾åŒºèšåˆä¿¡æ¯

**æ„å»ºå‡½æ•°**: 
- `database_utils.py::create_db_table_mysql()` - åˆ›å»ºè¡¨
- `database_utils.py::insert_data_to_mysql()` - æ’å…¥æ•°æ®

---

## ğŸ” æŸ¥è¯¢æµç¨‹

**è„šæœ¬**: `query_law_graph_apikey.py`

### æŸ¥è¯¢æ­¥éª¤è¯¦è§£

#### æ­¥éª¤1: å‘é‡æ£€ç´¢ï¼ˆVector Searchï¼‰

**å®ä½“å’Œæè¿°çš„å…³è”æ–¹å¼**:

åœ¨ Milvus å‘é‡åº“ä¸­ï¼Œæ¯ä¸ªå®ä½“å­˜å‚¨ä¸ºä¸€ä¸ªæ–‡æ¡£ï¼ŒåŒ…å«ï¼š
- `entity_name`: å®ä½“åç§°ï¼ˆä¸»é”®ï¼‰
- `description`: å®ä½“æè¿°ï¼ˆä¸å®ä½“åç§°ä¸€èµ·å­˜å‚¨åœ¨åŒä¸€æ–‡æ¡£ä¸­ï¼‰
- `parent`: çˆ¶èŠ‚ç‚¹
- `level`: å±‚çº§
- `vector`: å‘é‡è¡¨ç¤ºï¼ˆç”¨äºæ£€ç´¢ï¼‰
- `source_id`: æ¥æºchunk IDs

**æ£€ç´¢è¿‡ç¨‹**:
```python
# 1. å°†æŸ¥è¯¢é—®é¢˜è½¬æ¢ä¸ºå‘é‡
query_vector = embedding(query)  # ä½¿ç”¨ BAAI/bge-m3ï¼Œè¿”å›1024ç»´å‘é‡

# 2. åœ¨Milvusä¸­æ£€ç´¢Top-Kç›¸ä¼¼å®ä½“
search_results = milvus_client.search(
    collection_name="entity_collection",
    data=query_vector,           # æŸ¥è¯¢å‘é‡
    limit=topk,                   # è¿”å›å‰10ä¸ªæœ€ç›¸ä¼¼çš„å®ä½“
    filter=filter_field,          # å¯é€‰çš„å±‚çº§è¿‡æ»¤
    output_fields=["entity_name", "description", "parent", "level", "source_id"]
)

# 3. æå–ç»“æœï¼ˆå®ä½“å’Œæè¿°å·²ç»å…³è”åœ¨ä¸€èµ·ï¼‰
extract_results = [
    (
        item['entity']['entity_name'],    # å®ä½“åç§°
        item['entity']['parent'],         # çˆ¶èŠ‚ç‚¹
        item['entity']['description'],    # å®ä½“æè¿°ï¼ˆä¸å®ä½“åç§°ä¸€ä¸€å¯¹åº”ï¼‰
        item['entity']['source_id']       # æ¥æºchunk IDs
    )
    for item in search_results[0]
]
```

**å…³é”®ç‚¹**:
- âœ… **å®ä½“å’Œæè¿°å¤©ç„¶å…³è”**ï¼šå®ƒä»¬å­˜å‚¨åœ¨åŒä¸€ä¸ª Milvus æ–‡æ¡£ä¸­ï¼Œæ£€ç´¢æ—¶ä¸€èµ·è¿”å›
- âœ… **ä¸€ä¸€å¯¹åº”å…³ç³»**ï¼šæ¯ä¸ª `entity_name` å¯¹åº”ä¸€ä¸ª `description`
- âœ… **å‘é‡ç›¸ä¼¼åº¦æ’åº**ï¼šç»“æœæŒ‰ä¸æŸ¥è¯¢çš„è¯­ä¹‰ç›¸ä¼¼åº¦æ’åºï¼ˆå†…ç§¯/IPè·ç¦»ï¼‰

**è¿”å›æ ¼å¼**: 
```python
entity_results = [
    ("åŠ³åŠ¨åˆåŒ", "åŠ³åŠ¨æ³•å¾‹å…³ç³»", "åŠ³åŠ¨è€…ä¸ç”¨äººå•ä½ç¡®ç«‹åŠ³åŠ¨å…³ç³»...", "hash_code_1"),
    ("å·¥èµ„", "åŠ³åŠ¨æ³•å¾‹å…³ç³»", "åŠ³åŠ¨è€…å› æä¾›åŠ³åŠ¨è€Œè·å¾—çš„æŠ¥é…¬...", "hash_code_2"),
    ...
]
# æ ¼å¼: (entity_name, parent, description, source_id)
```

**æ•°æ®ç»“æ„è¯´æ˜**:
- **Milvuså­˜å‚¨**: æ¯ä¸ªå®ä½“ä½œä¸ºä¸€ä¸ªæ–‡æ¡£ï¼ŒåŒ…å«æ‰€æœ‰å­—æ®µï¼ˆentity_name, description, vectorç­‰ï¼‰
- **æ£€ç´¢è¿”å›**: Milvusè¿”å›çš„æ˜¯å®Œæ•´çš„æ–‡æ¡£ï¼ŒåŒ…å«æ‰€æœ‰ `output_fields` æŒ‡å®šçš„å­—æ®µ
- **å…³è”ä¿è¯**: å› ä¸ºå®ä½“åç§°å’Œæè¿°å­˜å‚¨åœ¨åŒä¸€ä¸ªæ–‡æ¡£ä¸­ï¼Œæ‰€ä»¥å®ƒä»¬å¤©ç„¶å…³è”ï¼Œä¸ä¼šå‡ºç°ä¸åŒ¹é…çš„æƒ…å†µ

---

#### æ­¥éª¤2: æå–å®ä½“ä¿¡æ¯

**ä»æ£€ç´¢ç»“æœä¸­æå–**:
```python
# æå–å®ä½“åç§°åˆ—è¡¨ï¼ˆç”¨äºåç»­æ¨ç†è·¯å¾„æ„å»ºï¼‰
res_entity = [i[0] for i in entity_results]
# ç»“æœ: ["åŠ³åŠ¨åˆåŒ", "å·¥èµ„", "åŠ³åŠ¨æ³•å¾‹å…³ç³»", ...]

# æå–source_idï¼ˆchunk IDsï¼Œç”¨äºåç»­æ–‡æœ¬å•å…ƒæå–ï¼‰
chunks = [i[-1] for i in entity_results]
# ç»“æœ: ["hash_code_1", "hash_code_2|hash_code_3", ...]

# æ ¼å¼åŒ–å®ä½“æè¿°ï¼ˆç”¨äºåç»­ç»„ç»‡ä¸Šä¸‹æ–‡ï¼‰
entity_descriptions = get_entity_description(entity_results)
# æ ¼å¼åŒ–ä¸ºè¡¨æ ¼å½¢å¼ï¼š
# entity_name    parent    description
# åŠ³åŠ¨åˆåŒ      åŠ³åŠ¨æ³•å¾‹å…³ç³»   åŠ³åŠ¨è€…ä¸ç”¨äººå•ä½ç¡®ç«‹åŠ³åŠ¨å…³ç³»...
# å·¥èµ„          åŠ³åŠ¨æ³•å¾‹å…³ç³»   åŠ³åŠ¨è€…å› æä¾›åŠ³åŠ¨è€Œè·å¾—çš„æŠ¥é…¬...
```

**å…³é”®ç‚¹**:
- å®ä½“åç§°å’Œæè¿°åœ¨æ£€ç´¢æ—¶å·²ç»å…³è”ï¼Œç›´æ¥ä½¿ç”¨å³å¯
- `source_id` ç”¨äºåç»­ä»åŸå§‹chunkæ–‡ä»¶ä¸­æå–æ–‡æœ¬è¯æ®

**ä»æ£€ç´¢ç»“æœä¸­æå–**:
```python
# æå–å®ä½“åç§°åˆ—è¡¨
res_entity = [i[0] for i in entity_results]
# ç»“æœ: ["åŠ³åŠ¨åˆåŒ", "å·¥èµ„", "åŠ³åŠ¨æ³•å¾‹å…³ç³»", ...]

# æå–source_idï¼ˆchunk IDsï¼‰
chunks = [i[-1] for i in entity_results]
# ç»“æœ: ["hash_code_1", "hash_code_2|hash_code_3", ...]

# æ ¼å¼åŒ–å®ä½“æè¿°ï¼ˆç”¨äºåç»­ç»„ç»‡ä¸Šä¸‹æ–‡ï¼‰
entity_descriptions = get_entity_description(entity_results)
# æ ¼å¼åŒ–ä¸ºè¡¨æ ¼å½¢å¼ï¼š
# entity_name    parent    description
# åŠ³åŠ¨åˆåŒ      åŠ³åŠ¨æ³•å¾‹å…³ç³»   åŠ³åŠ¨è€…ä¸ç”¨äººå•ä½ç¡®ç«‹åŠ³åŠ¨å…³ç³»...
# å·¥èµ„          åŠ³åŠ¨æ³•å¾‹å…³ç³»   åŠ³åŠ¨è€…å› æä¾›åŠ³åŠ¨è€Œè·å¾—çš„æŠ¥é…¬...
```

---

#### æ­¥éª¤3: æ„å»ºæ¨ç†è·¯å¾„ï¼ˆReasoning Chainï¼‰

**è¾“å…¥**: `res_entity` - ä»æ­¥éª¤2æå–çš„å®ä½“åç§°åˆ—è¡¨

**å¤„ç†æµç¨‹**:
```python
# 1. å¯¹æ¯å¯¹å®ä½“ï¼Œæ„å»ºæ¨ç†è·¯å¾„
maybe_edges = list(combinations(res_entity, 2))  # æ‰€æœ‰å®ä½“å¯¹
reasoning_path = []
reasoning_path_information = []

for edge in maybe_edges:
    node1, node2 = edge[0], edge[1]
    
    # 2. æ‰¾åˆ°æ¯ä¸ªå®ä½“åˆ°æ ¹èŠ‚ç‚¹çš„è·¯å¾„
    node1_tree = find_tree_root(db_name, node1)  # ["åŠ³åŠ¨åˆåŒ", "åŠ³åŠ¨æ³•å¾‹å…³ç³»", "åŠ³åŠ¨æ³•ä½“ç³»", "root"]
    node2_tree = find_tree_root(db_name, node2)  # ["å·¥èµ„", "åŠ³åŠ¨æ³•å¾‹å…³ç³»", "åŠ³åŠ¨æ³•ä½“ç³»", "root"]
    
    # 3. æ‰¾åˆ°å…¬å…±ç¥–å…ˆï¼ˆè·¯å¾„çš„äº¤é›†ç‚¹ï¼‰
    # ä¾‹å¦‚ï¼šå…¬å…±ç¥–å…ˆæ˜¯"åŠ³åŠ¨æ³•å¾‹å…³ç³»"
    
    # 4. æ„å»ºå®Œæ•´è·¯å¾„
    a_path = []  # ä»node1åˆ°å…¬å…±ç¥–å…ˆçš„è·¯å¾„
    b_path = []  # ä»node2åˆ°å…¬å…±ç¥–å…ˆçš„è·¯å¾„
    # ... è·¯å¾„æ„å»ºé€»è¾‘ ...
    
    # 5. æŸ¥è¯¢è·¯å¾„ä¸Šæ‰€æœ‰èŠ‚ç‚¹å¯¹ä¹‹é—´çš„å…³ç³»
    for maybe_edge in list(combinations(a_path + b_path, 2)):
        information = search_nodes_link(maybe_edge[0], maybe_edge[1], working_dir)
        # ä»MySQLçš„relationsè¡¨æŸ¥è¯¢å…³ç³»æè¿°
        if information:
            reasoning_path_information.append([node1, node2, information[2]])  # information[2]æ˜¯å…³ç³»æè¿°
```

**è¾“å‡º**:
- `reasoning_path`: æ¨ç†è·¯å¾„åˆ—è¡¨ï¼ˆå®ä½“åºåˆ—ï¼‰
- `reasoning_path_information_description`: è·¯å¾„ä¸Šæ‰€æœ‰å…³ç³»çš„æè¿°æ–‡æœ¬

**ç¤ºä¾‹**:
```
æ¨ç†è·¯å¾„: ["åŠ³åŠ¨åˆåŒ", "åŠ³åŠ¨æ³•å¾‹å…³ç³»", "å·¥èµ„"]
å…³ç³»æè¿°: "åŠ³åŠ¨åˆåŒè§„å®šäº†å·¥èµ„æ”¯ä»˜æ ‡å‡†..."
```

---

#### æ­¥éª¤4: èšåˆç¤¾åŒºä¿¡æ¯ï¼ˆCommunity Aggregationï¼‰

**è¾“å…¥**: `reasoning_path` - ä»æ­¥éª¤3å¾—åˆ°çš„æ¨ç†è·¯å¾„

**å¤„ç†æµç¨‹**:
```python
# 1. ä»æ¨ç†è·¯å¾„ä¸­æå–æ‰€æœ‰æ¶‰åŠçš„ç¤¾åŒº/èšåˆèŠ‚ç‚¹
communities = set([community for each_path in reasoning_path for community in each_path])
# ç»“æœ: {"åŠ³åŠ¨æ³•å¾‹å…³ç³»", "åŠ³åŠ¨æ³•ä½“ç³»", ...}

# 2. æŸ¥è¯¢æ¯ä¸ªç¤¾åŒºçš„è¯¦ç»†ä¿¡æ¯
aggregation_results = []
for community in communities:
    temp = search_community(community, working_dir)
    # ä»MySQLçš„communitiesè¡¨æŸ¥è¯¢ï¼š
    # SELECT * FROM communities WHERE entity_name = community
    # è¿”å›: (entity_name, entity_description, findings)
    if temp:
        aggregation_results.append(temp)

# 3. æ ¼å¼åŒ–è¾“å‡º
aggregation_descriptions = "\t\t".join(["entity_name", "entity_description"]) + "\n"
aggregation_descriptions += "\n".join([
    info[0] + "\t\t" + str(info[1])  # entity_name + entity_description
    for info in aggregation_results
])
```

**åŠŸèƒ½**:
- æŸ¥è¯¢MySQLçš„ `communities` è¡¨
- è·å–ç¤¾åŒº/èšåˆèŠ‚ç‚¹çš„æè¿°å’Œå‘ç°ï¼ˆfindingsï¼‰
- æä¾›æ›´é«˜å±‚æ¬¡çš„ä¸Šä¸‹æ–‡ä¿¡æ¯

**è¾“å‡ºç¤ºä¾‹**:
```
entity_name    entity_description
åŠ³åŠ¨æ³•å¾‹å…³ç³»   æ¶µç›–åŠ³åŠ¨åˆåŒã€å·¥èµ„ã€å·¥ä½œæ—¶é—´ç­‰æ ¸å¿ƒè¦ç´ ...
åŠ³åŠ¨æ³•ä½“ç³»     åŒ…æ‹¬åŠ³åŠ¨æ³•å¾‹å…³ç³»ã€åŠ³åŠ¨äº‰è®®å¤„ç†ç­‰å­ç³»ç»Ÿ...
```

---

#### æ­¥éª¤5: æå–æ–‡æœ¬å•å…ƒï¼ˆText Unitsï¼‰

**è¾“å…¥**: `chunks` - ä»æ­¥éª¤2æå–çš„source_idåˆ—è¡¨ï¼ˆchunk hash_codesï¼‰

**å¤„ç†æµç¨‹**:
```python
# 1. è§£æsource_idï¼ˆå¯èƒ½åŒ…å«å¤šä¸ªhash_codeï¼Œç”¨|åˆ†éš”ï¼‰
chunks_list = []
for chunks in chunks_set:
    if "|" in chunks:
        temp_chunks = chunks.split("|")  # æ‹†åˆ†å¤šä¸ªhash_code
    else:
        temp_chunks = [chunks]
    chunks_list += temp_chunks

# 2. ç»Ÿè®¡hash_codeå‡ºç°é¢‘ç‡ï¼Œé€‰æ‹©æœ€é¢‘ç¹çš„kä¸ª
counter = Counter(chunks_list)
# ä¾‹å¦‚: {"hash_code_1": 3, "hash_code_2": 2, "hash_code_3": 1}

# 3. é€‰æ‹©å‡ºç°æ¬¡æ•°æœ€å¤šçš„kä¸ªchunkï¼ˆä¼˜å…ˆé€‰æ‹©è¢«å¤šä¸ªå®ä½“å¼•ç”¨çš„chunkï¼‰
duplicates = sorted(
    [(item, count) for item, count in counter.items() if count > 1],
    key=lambda x: x[1],
    reverse=True
)[:k]

# 4. ä»åŸå§‹chunkæ–‡ä»¶ä¸­è¯»å–æ–‡æœ¬å†…å®¹
chunks_dict = {}
with open(chunks_file, 'r', encoding='utf-8') as f:
    chunks_data = json.load(f)
    chunks_dict = {item["hash_code"]: item["text"] for item in chunks_data}

# 5. æå–æ–‡æœ¬å•å…ƒ
text_units = ""
for chunk_hash in duplicates:
    if chunk_hash in chunks_dict:
        text_units += chunks_dict[chunk_hash] + "\n"
```

**åŠŸèƒ½**:
- ä» `source_id` ä¸­æå–æ‰€æœ‰hash_code
- ç»Ÿè®¡é¢‘ç‡ï¼Œä¼˜å…ˆé€‰æ‹©è¢«å¤šä¸ªå®ä½“å¼•ç”¨çš„chunkï¼ˆè¯´æ˜æ›´é‡è¦ï¼‰
- ä»åŸå§‹chunkæ–‡ä»¶ä¸­è¯»å–å¯¹åº”çš„æ–‡æœ¬å†…å®¹
- ä½œä¸º**åŸå§‹æ–‡æœ¬è¯æ®**è¿”å›ç»™LLM

**å…³é”®ç‚¹**:
- âœ… **é¢‘ç‡ä¼˜å…ˆ**ï¼šå‡ºç°æ¬¡æ•°å¤šçš„chunkæ›´å¯èƒ½åŒ…å«é‡è¦ä¿¡æ¯
- âœ… **åŸå§‹æ–‡æœ¬**ï¼šæä¾›æœ€ç›´æ¥çš„è¯æ®æ”¯æŒ
- âœ… **å¯è¿½æº¯æ€§**ï¼šé€šè¿‡hash_codeå¯ä»¥è¿½æº¯åˆ°å…·ä½“çš„æ³•å¾‹æ¡æ–‡

---

#### æ­¥éª¤6: ç»„ç»‡ä¸Šä¸‹æ–‡å¹¶ç”Ÿæˆå›ç­”

**ç»„ç»‡æ‰€æœ‰æ£€ç´¢åˆ°çš„ä¿¡æ¯**:
```python
describe = f"""
entity_information:
{entity_descriptions}              # æ­¥éª¤2: ç›´æ¥æ£€ç´¢åˆ°çš„å®ä½“ä¿¡æ¯
aggregation_entity_information:
{aggregation_descriptions}         # æ­¥éª¤4: ç¤¾åŒºèšåˆä¿¡æ¯ï¼ˆé«˜å±‚æ¬¡æ¦‚å¿µï¼‰
reasoning_path_information:
{reasoning_path_information_description}  # æ­¥éª¤3: æ¨ç†è·¯å¾„ä¿¡æ¯ï¼ˆå®ä½“é—´å…³ç³»ï¼‰
text_units:
{text_units}                       # æ­¥éª¤5: åŸå§‹æ–‡æœ¬è¯æ®ï¼ˆæ³•å¾‹æ¡æ–‡åŸæ–‡ï¼‰
"""
```

**ä¸Šä¸‹æ–‡ç»“æ„**:
1. **entity_information**: ç›´æ¥åŒ¹é…çš„å®ä½“ï¼ˆTop-Kæ£€ç´¢ç»“æœï¼‰
2. **aggregation_entity_information**: èšåˆå®ä½“ï¼ˆæä¾›æ›´é«˜å±‚æ¬¡çš„ä¸Šä¸‹æ–‡ï¼‰
3. **reasoning_path_information**: æ¨ç†è·¯å¾„ï¼ˆå±•ç¤ºå®ä½“é—´çš„é€»è¾‘å…³ç³»ï¼‰
4. **text_units**: åŸå§‹æ–‡æœ¬ï¼ˆæä¾›å…·ä½“çš„æ³•å¾‹æ¡æ–‡è¯æ®ï¼‰

**ç”Ÿæˆæœ€ç»ˆå›ç­”**:
```python
# æ„å»ºç³»ç»Ÿæç¤ºè¯
sys_prompt = PROMPTS["rag_response"].format(context_data=describe)

# è°ƒç”¨LLMç”Ÿæˆå›ç­”
response = use_llm_func(
    query,              # ç”¨æˆ·æŸ¥è¯¢é—®é¢˜
    system_prompt=sys_prompt  # åŒ…å«æ‰€æœ‰æ£€ç´¢ä¸Šä¸‹æ–‡çš„ç³»ç»Ÿæç¤ºè¯
)
```

**LLMè¾“å…¥**:
- **ç”¨æˆ·æŸ¥è¯¢**: åŸå§‹é—®é¢˜ï¼ˆå¦‚"ä»€ä¹ˆæ˜¯åŠ³åŠ¨åˆåŒï¼Ÿ"ï¼‰
- **ç³»ç»Ÿæç¤ºè¯**: åŒ…å«æ‰€æœ‰æ£€ç´¢åˆ°çš„ä¸Šä¸‹æ–‡ä¿¡æ¯

**LLMè¾“å‡º**: åŸºäºçŸ¥è¯†å›¾è°±çš„æœ€ç»ˆå›ç­”

---

### å®Œæ•´æ•°æ®æµè½¬å›¾

```
ç”¨æˆ·æŸ¥è¯¢: "ä»€ä¹ˆæ˜¯åŠ³åŠ¨åˆåŒï¼Ÿ"
    â†“
[æ­¥éª¤1] å‘é‡æ£€ç´¢
    â†“
Milvusè¿”å›: [
    (entity_name="åŠ³åŠ¨åˆåŒ", description="...", source_id="hash_1"),
    (entity_name="å·¥èµ„", description="...", source_id="hash_2"),
    ...
]
    â†“
[æ­¥éª¤2] æå–ä¿¡æ¯
    â†“
res_entity = ["åŠ³åŠ¨åˆåŒ", "å·¥èµ„", ...]
chunks = ["hash_1", "hash_2", ...]
entity_descriptions = "è¡¨æ ¼æ ¼å¼çš„å®ä½“ä¿¡æ¯"
    â†“
[æ­¥éª¤3] æ„å»ºæ¨ç†è·¯å¾„
    â†“
reasoning_path = [["åŠ³åŠ¨åˆåŒ", "åŠ³åŠ¨æ³•å¾‹å…³ç³»", ...], ...]
reasoning_path_info = "å…³ç³»æè¿°æ–‡æœ¬"
    â†“
[æ­¥éª¤4] èšåˆç¤¾åŒºä¿¡æ¯
    â†“
aggregation_descriptions = "ç¤¾åŒº/èšåˆå®ä½“æè¿°"
    â†“
[æ­¥éª¤5] æå–æ–‡æœ¬å•å…ƒ
    â†“
text_units = "åŸå§‹æ³•å¾‹æ¡æ–‡æ–‡æœ¬"
    â†“
[æ­¥éª¤6] ç»„ç»‡ä¸Šä¸‹æ–‡
    â†“
describe = """
entity_information: ...
aggregation_entity_information: ...
reasoning_path_information: ...
text_units: ...
"""
    â†“
[LLMç”Ÿæˆ]
    â†“
æœ€ç»ˆå›ç­”: "åŠ³åŠ¨åˆåŒæ˜¯æŒ‡..."
```

---

## ğŸ“Š è¿è¡Œæ—¥å¿—è¯´æ˜

### `law_extract_graphrag.py` è¿è¡Œæ—¶çš„æ—¥å¿—ä¿¡æ¯

è¿è¡Œ `law_extract_graphrag.py` æ—¶ï¼Œç»ˆç«¯ä¼šæ˜¾ç¤ºä¸¤ç±»æ—¥å¿—ä¿¡æ¯ï¼š

---

#### 1. å·¦ä¾§æ—¥å¿—ï¼švLLM è¯·æ±‚å¤„ç†çŠ¶æ€

**æ—¥å¿—æ ¼å¼**:
```
Adding requests: 100%|
Processed prompts: 100%
```

**å«ä¹‰**:
- **Adding requests: 100%**: vLLM æ­£åœ¨å°†è¯·æ±‚æ·»åŠ åˆ°å¤„ç†é˜Ÿåˆ—
  - æ¯ä¸ª chunk çš„å®ä½“/å…³ç³»æå–è¯·æ±‚è¢«æ·»åŠ åˆ° vLLM çš„æ‰¹å¤„ç†é˜Ÿåˆ—
  - 100% è¡¨ç¤ºè¯¥æ‰¹æ¬¡çš„è¯·æ±‚å·²å…¨éƒ¨æ·»åŠ å®Œæˆ
  
- **Processed prompts: 100%**: vLLM å·²å®Œæˆæç¤ºè¯å¤„ç†
  - æç¤ºè¯å·²ç¼–ç å¹¶é€å…¥æ¨¡å‹
  - 100% è¡¨ç¤ºè¯¥æ‰¹æ¬¡çš„æç¤ºè¯å·²å…¨éƒ¨å¤„ç†å®Œæˆ

**å¤„ç†æµç¨‹**:
```
Chunk 1 â†’ æ„å»ºæç¤ºè¯ â†’ æ·»åŠ åˆ°é˜Ÿåˆ— â†’ ç¼–ç æç¤ºè¯ â†’ ç”Ÿæˆå“åº”
Chunk 2 â†’ æ„å»ºæç¤ºè¯ â†’ æ·»åŠ åˆ°é˜Ÿåˆ— â†’ ç¼–ç æç¤ºè¯ â†’ ç”Ÿæˆå“åº”
...
```

---

#### 2. å³ä¾§æ—¥å¿—ï¼šæ¯ä¸ª Chunk çš„å¤„ç†è¿›åº¦

**æ—¥å¿—æ ¼å¼**:
```
1/1 [00:14<00:00, 14.36s/it, est. speed input: 35.94 to]
```

**å­—æ®µè¯´æ˜**:
- **`1/1`**: å½“å‰ä»»åŠ¡å®ŒæˆçŠ¶æ€
  - ç¬¬ä¸€ä¸ªæ•°å­—ï¼šå·²å®Œæˆçš„è¯·æ±‚æ•°
  - ç¬¬äºŒä¸ªæ•°å­—ï¼šæ€»è¯·æ±‚æ•°
  - `1/1` è¡¨ç¤ºè¯¥ chunk çš„å¤„ç†å·²å®Œæˆ

- **`[00:14<00:00, ...]`**: æ—¶é—´ä¿¡æ¯
  - `00:14`: å·²ç”¨æ—¶é—´ï¼ˆ14ç§’ï¼‰
  - `<00:00`: å‰©ä½™æ—¶é—´ï¼ˆ0ç§’ï¼Œè¡¨ç¤ºå·²å®Œæˆï¼‰
  - `14.36s/it`: æ¯ä¸ªè¿­ä»£ï¼ˆiterationï¼‰çš„å¹³å‡è€—æ—¶ï¼ˆ14.36ç§’ï¼‰

- **`est. speed input: 35.94 to`**: ä¼°è®¡çš„å¤„ç†é€Ÿåº¦
  - `35.94`: æ¯ç§’å¤„ç†çš„ token æ•°
  - `to`: tokensï¼ˆtokens çš„ç¼©å†™ï¼‰

**ç¤ºä¾‹è§£è¯»**:
```
1/1 [00:14<00:00, 14.36s/it, est. speed input: 35.94 to]
```
- âœ… è¯¥ chunk å·²å¤„ç†å®Œæˆï¼ˆ1/1ï¼‰
- â±ï¸ è€—æ—¶ 14 ç§’
- ğŸ“Š å¹³å‡æ¯ä¸ªè¯·æ±‚ 14.36 ç§’
- ğŸš€ å¤„ç†é€Ÿåº¦çº¦ 35.94 tokens/ç§’

---

### å®Œæ•´çš„å¤„ç†æµç¨‹

#### é˜¶æ®µ1: å®ä½“æå–ï¼ˆEntity Extractionï¼‰

**æ—¥å¿—æ˜¾ç¤º**:
```
Adding requests: 100%|
Processed prompts: 100%
1/1 [00:14<00:00, 14.36s/it, est. speed input: 35.94 to]
1/1 [00:15<00:00, 15.11s/it, est. speed input: 28.92 to]
...
```

**å®é™…è¿‡ç¨‹**:
1. **å¹¶å‘å¤„ç†**: ä½¿ç”¨ `asyncio.gather` å¹¶å‘å¤„ç†æ‰€æœ‰ chunk
   ```python
   entity_results = await asyncio.gather(
       *[_process_single_content_entity(c, use_llm_func) for c in ordered_chunks]
   )
   ```

2. **æ¯ä¸ª chunk çš„å¤„ç†**:
   - æ„å»ºå®ä½“æå–æç¤ºè¯
   - è°ƒç”¨ vLLM ç”Ÿæˆå®ä½“åˆ—è¡¨
   - è§£æè¿”å›ç»“æœï¼Œæå–å®ä½“åç§°ã€ç±»å‹ã€æè¿°
   - å¯èƒ½è¿›è¡Œå¤šè½®æå–ï¼ˆgleaningï¼‰ä»¥è¡¥å……é—æ¼çš„å®ä½“

3. **è¾“å‡º**: æ¯ä¸ª chunk æå–å‡ºçš„å®ä½“åˆ—è¡¨

---

#### é˜¶æ®µ2: å…³ç³»æå–ï¼ˆRelation Extractionï¼‰

**æ—¥å¿—æ˜¾ç¤º**:
```
Adding requests: 100%|
Processed prompts: 100%
1/1 [00:18<00:00, 18.03s/it, est. speed input: 28.96 to]
1/1 [00:09<00:00, 9.24s/it, est. speed input: 50.63 to]
...
```

**å®é™…è¿‡ç¨‹**:
1. **ä½¿ç”¨å·²æå–çš„å®ä½“**: å…³ç³»æå–ä¼šä½¿ç”¨é˜¶æ®µ1æå–çš„å®ä½“ä½œä¸ºä¸Šä¸‹æ–‡
   ```python
   entities = context_entities[chunk_key]  # è¯¥chunkä¸­æå–çš„å®ä½“
   context_base_relation = dict(
       entities=",".join(entities)  # å°†å®ä½“åˆ—è¡¨ä½œä¸ºä¸Šä¸‹æ–‡
   )
   ```

2. **æ¯ä¸ª chunk çš„å¤„ç†**:
   - æ„å»ºå…³ç³»æå–æç¤ºè¯ï¼ˆåŒ…å«è¯¥chunkçš„å®ä½“åˆ—è¡¨ï¼‰
   - è°ƒç”¨ vLLM ç”Ÿæˆå…³ç³»åˆ—è¡¨
   - è§£æè¿”å›ç»“æœï¼Œæå–å…³ç³»ï¼ˆsrc_id, tgt_id, description, weightï¼‰
   - å¯èƒ½è¿›è¡Œå¤šè½®æå–ä»¥è¡¥å……é—æ¼çš„å…³ç³»

3. **è¾“å‡º**: æ¯ä¸ª chunk æå–å‡ºçš„å…³ç³»åˆ—è¡¨

---

### å¤„ç†æ—¶é—´åˆ†æ

**ä»æ—¥å¿—å¯ä»¥çœ‹å‡º**:

1. **å¤„ç†æ—¶é—´å·®å¼‚å¤§**:
   - æœ€çŸ­: `2.74s/it` (çº¦ 170 tokens/ç§’)
   - æœ€é•¿: `35.97s/it` (çº¦ 12 tokens/ç§’)
   - å¹³å‡: çº¦ `10-20s/it`

2. **é€Ÿåº¦å·®å¼‚çš„åŸå› **:
   - **Chunk é•¿åº¦**: è¾ƒé•¿çš„ chunk éœ€è¦æ›´å¤šæ—¶é—´
   - **å®ä½“/å…³ç³»æ•°é‡**: æå–çš„å®ä½“å’Œå…³ç³»è¶Šå¤šï¼Œå¤„ç†æ—¶é—´è¶Šé•¿
   - **æ¨¡å‹å¤æ‚åº¦**: æŸäº›å¤æ‚çš„æ³•å¾‹æ¦‚å¿µéœ€è¦æ›´é•¿çš„æ¨ç†æ—¶é—´
   - **GPU è´Ÿè½½**: å…¶ä»–è¿›ç¨‹å¯èƒ½å½±å“å¤„ç†é€Ÿåº¦

3. **æ€§èƒ½æŒ‡æ ‡**:
   - **è¾“å…¥é€Ÿåº¦**: `12-170 tokens/ç§’`ï¼ˆå·®å¼‚è¾ƒå¤§ï¼‰
   - **å¹³å‡é€Ÿåº¦**: çº¦ `30-70 tokens/ç§’`ï¼ˆå¤§å¤šæ•°æƒ…å†µï¼‰

---

### è¿›åº¦ç›‘æ§

**è„šæœ¬å†…éƒ¨ä¹Ÿä¼šæ˜¾ç¤ºè¿›åº¦**ï¼ˆä½†å¯èƒ½è¢« vLLM çš„è¾“å‡ºè¦†ç›–ï¼‰:
```python
# ä»£ç ä½ç½®: GraphExtraction/chunk.py ç¬¬205-209è¡Œå’Œç¬¬295-299è¡Œ
print(
    f"{now_ticks} Processed {already_processed}({already_processed*100//len(ordered_chunks)}%) chunks,  {already_entities} entities(duplicated), {already_relations} relations(duplicated)\r",
    end="",
    flush=True,
)
```

**é¢„æœŸè¾“å‡ºæ ¼å¼**:
```
â ‹ Processed 50(25%) chunks, 1234 entities(duplicated), 567 relations(duplicated)
```

**å­—æ®µè¯´æ˜**:
- **`â ‹` (æ—‹è½¬åŠ¨ç”»å­—ç¬¦)**: è¿›åº¦æŒ‡ç¤ºå™¨ï¼Œä¼šå¾ªç¯æ˜¾ç¤º `â ‹â ™â ¹â ¸â ¼â ´â ¦â §â ‡â `
- **Processed 50(25%)**: å·²å¤„ç† 50 ä¸ª chunkï¼Œå æ€»æ•°çš„ 25%
- **1234 entities(duplicated)**: å·²æå– 1234 ä¸ªå®ä½“ï¼ˆå¯èƒ½æœ‰é‡å¤ï¼‰
- **567 relations(duplicated)**: å·²æå– 567 ä¸ªå…³ç³»ï¼ˆå¯èƒ½æœ‰é‡å¤ï¼‰

**ä¸ºä»€ä¹ˆå¯èƒ½çœ‹ä¸åˆ°è¿™ä¸ªè¿›åº¦ä¿¡æ¯**:

1. **è¢« vLLM è¾“å‡ºè¦†ç›–**:
   - vLLM çš„ "Adding requests" å’Œè¿›åº¦æ¡è¾“å‡ºå¯èƒ½ä¼šè¦†ç›–è¿™ä¸ªè¿›åº¦ä¿¡æ¯
   - ä¸¤è€…éƒ½åœ¨åŒä¸€ç»ˆç«¯è¾“å‡ºï¼Œå¯èƒ½ä¼šäº’ç›¸å¹²æ‰°

2. **ä½¿ç”¨ `\r` è¦†ç›–åŒä¸€è¡Œ**:
   - ä»£ç ä½¿ç”¨ `\r` (å›è½¦ç¬¦) å’Œ `end=""` æ¥åœ¨åŒä¸€è¡Œæ›´æ–°è¿›åº¦
   - å¦‚æœç»ˆç«¯ä¸æ”¯æŒè¿™ç§è¦†ç›–ï¼Œæˆ–è€…è¾“å‡ºè¢«é‡å®šå‘ï¼Œå¯èƒ½çœ‹ä¸åˆ°æ›´æ–°

3. **å¼‚æ­¥å¹¶å‘å¤„ç†**:
   - å¤šä¸ª chunk åŒæ—¶å¤„ç†ï¼Œå¤šä¸ªè¿›åº¦ä¿¡æ¯å¯èƒ½åŒæ—¶æ‰“å°
   - å¯èƒ½å¯¼è‡´è¾“å‡ºæ··ä¹±

4. **è¾“å‡ºé‡å®šå‘**:
   - å¦‚æœè¾“å‡ºè¢«é‡å®šå‘åˆ°æ–‡ä»¶ï¼ˆå¦‚ `python script.py > log.txt`ï¼‰ï¼Œ`\r` å¯èƒ½ä¸ä¼šæ­£å¸¸å·¥ä½œ

**å¦‚ä½•æŸ¥çœ‹è¿›åº¦ä¿¡æ¯**:

1. **æŸ¥çœ‹ç»ˆç«¯è¾“å‡º**:
   - åœ¨ç»ˆç«¯ä¸­ç›´æ¥è¿è¡Œè„šæœ¬ï¼Œä¸è¦é‡å®šå‘è¾“å‡º
   - æ³¨æ„è§‚å¯Ÿç»ˆç«¯ä¸­æ˜¯å¦æœ‰æ—‹è½¬çš„åŠ¨ç”»å­—ç¬¦å’Œè¿›åº¦ä¿¡æ¯

2. **æŸ¥çœ‹æœ€ç»ˆè¾“å‡º**:
   - è„šæœ¬å®Œæˆåï¼Œä¼šæ‰“å°æœ€ç»ˆç»Ÿè®¡ä¿¡æ¯
   - æŸ¥çœ‹ `entity.jsonl` å’Œ `relation.jsonl` æ–‡ä»¶çš„è¡Œæ•°ï¼Œå¯ä»¥çŸ¥é“å®é™…æå–çš„æ•°é‡

3. **ä¿®æ”¹ä»£ç ä»¥æ›´æ¸…æ™°åœ°æ˜¾ç¤º**:
   ```python
   # å¦‚æœæƒ³æ›´æ¸…æ¥šåœ°çœ‹åˆ°è¿›åº¦ï¼Œå¯ä»¥ä¿®æ”¹ chunk.py ä¸­çš„æ‰“å°è¯­å¥
   # å°† \r æ”¹ä¸º \nï¼Œè¿™æ ·æ¯æ¬¡éƒ½ä¼šæ¢è¡Œæ˜¾ç¤º
   print(
       f"{now_ticks} Processed {already_processed}({already_processed*100//len(ordered_chunks)}%) chunks,  {already_entities} entities(duplicated), {already_relations} relations(duplicated)\n",
       end="",
       flush=True,
   )
   ```

**æ³¨æ„**: 
- "duplicated" è¡¨ç¤ºè¿™äº›æ˜¯åŸå§‹æå–ç»“æœï¼Œåç»­ä¼šè¿›è¡Œå»é‡å’Œåˆå¹¶
- æœ€ç»ˆå†™å…¥æ–‡ä»¶çš„å®ä½“å’Œå…³ç³»æ•°é‡ä¼šå°‘äºè¿™ä¸ªæ•°å­—
- å®ä½“æå–é˜¶æ®µå’Œå…³ç³»æå–é˜¶æ®µéƒ½ä¼šæ˜¾ç¤ºå„è‡ªçš„è¿›åº¦

---

### æ—¥å¿—ä¿¡æ¯æ€»ç»“

| æ—¥å¿—ç±»å‹ | å«ä¹‰ | é˜¶æ®µ |
|---------|------|------|
| `Adding requests: 100%` | vLLM æ·»åŠ è¯·æ±‚åˆ°é˜Ÿåˆ— | å®ä½“/å…³ç³»æå– |
| `Processed prompts: 100%` | vLLM å¤„ç†æç¤ºè¯å®Œæˆ | å®ä½“/å…³ç³»æå– |
| `1/1 [XX:XX<00:00, XX.XXs/it, ...]` | å•ä¸ª chunk å¤„ç†å®Œæˆ | å®ä½“/å…³ç³»æå– |
| `Processed X(Y%) chunks, ...` | æ€»ä½“è¿›åº¦ç»Ÿè®¡ | å®ä½“/å…³ç³»æå– |

---

### ä¼˜åŒ–å»ºè®®

å¦‚æœå¤„ç†é€Ÿåº¦è¾ƒæ…¢ï¼Œå¯ä»¥è€ƒè™‘ï¼š

1. **å¢åŠ å¹¶å‘æ•°**:
   ```python
   # åœ¨ law_extract_graphrag.py ä¸­
   max_concurrent = int(os.environ.get('VLLM_MAX_CONCURRENT', '2'))  # ä»1æ”¹ä¸º2
   ```

2. **ä½¿ç”¨æ›´å¤š GPU**:
   ```python
   'tensor_parallel_size': 4,  # ä½¿ç”¨4å¼ GPU
   ```

3. **è°ƒæ•´æ‰¹å¤„ç†å¤§å°**:
   - vLLM ä¼šè‡ªåŠ¨æ‰¹å¤„ç†è¯·æ±‚ï¼Œä½†å¯ä»¥é€šè¿‡è°ƒæ•´ `max_concurrent` æ¥æ§åˆ¶

4. **æ£€æŸ¥ GPU ä½¿ç”¨ç‡**:
   ```bash
   nvidia-smi
   ```
   - ç¡®ä¿ GPU æ²¡æœ‰è¢«å…¶ä»–è¿›ç¨‹å ç”¨
   - ç¡®ä¿ GPU åˆ©ç”¨ç‡æ¥è¿‘ 100%

---

## ğŸ”„ å®ä½“æå–æ¬¡æ•°è¯¦è§£

### æ¯ä¸ª Chunk çš„å®ä½“æå–æµç¨‹

å¯¹äº**æ¯ä¸ª chunk**ï¼Œä»£ç ä¼šè¿›è¡Œ**å¤šæ¬¡ LLM è°ƒç”¨**æ¥æå–å®ä½“ï¼Œä»¥ç¡®ä¿æå–çš„å®Œæ•´æ€§ã€‚

---

### æå–æ¬¡æ•°åˆ†æ

#### ä»£ç ä½ç½®ï¼š`GraphExtraction/chunk.py` ç¬¬150-168è¡Œ

```python
entity_extract_max_gleaning = 1  # æœ€å¤§è¡¥å……æå–æ¬¡æ•°

# ç¬¬1æ¬¡ï¼šåˆå§‹å®ä½“æå–
hint_prompt = entity_extract_prompt.format(**context_base_entity, input_text=content)
final_result = await use_llm_func(hint_prompt)  # â† ç¬¬1æ¬¡LLMè°ƒç”¨

history = pack_user_ass_to_openai_messages(hint_prompt, final_result)

# è¡¥å……æå–å¾ªç¯ï¼ˆgleaningï¼‰
for now_glean_index in range(entity_extract_max_gleaning):  # max_gleaning=1ï¼Œå¾ªç¯1æ¬¡
    # ç¬¬2æ¬¡ï¼šè¡¥å……æå–ï¼ˆç»§ç»­æå–é—æ¼çš„å®ä½“ï¼‰
    glean_result = await use_llm_func(continue_prompt, history_messages=history)  # â† ç¬¬2æ¬¡LLMè°ƒç”¨
    
    history += pack_user_ass_to_openai_messages(continue_prompt, glean_result)
    final_result += glean_result
    
    if now_glean_index == entity_extract_max_gleaning - 1:
        break  # å¦‚æœæ˜¯æœ€åä¸€æ¬¡ï¼Œç›´æ¥é€€å‡º
    
    # åˆ¤æ–­æ˜¯å¦éœ€è¦ç»§ç»­æå–ï¼ˆå½“max_gleaning>1æ—¶æ‰ä¼šæ‰§è¡Œï¼‰
    if_loop_result = await use_llm_func(if_loop_prompt, history_messages=history)
    if if_loop_result != "yes":
        break
```

---

### æå–æ¬¡æ•°æ€»ç»“

#### å½“å‰é…ç½®ï¼ˆ`entity_extract_max_gleaning=1`ï¼‰

**æ¯ä¸ª chunk çš„å®ä½“æå–æ¬¡æ•°ï¼š2æ¬¡**

1. **ç¬¬1æ¬¡ï¼šåˆå§‹æå–**
   - ä½¿ç”¨ `entity_extract_prompt` æç¤ºè¯
   - ä»æ–‡æœ¬ä¸­æå–æ‰€æœ‰å®ä½“
   - è¿”å›ï¼šå®ä½“åˆ—è¡¨

2. **ç¬¬2æ¬¡ï¼šè¡¥å……æå–ï¼ˆGleaningï¼‰**
   - ä½¿ç”¨ `entiti_continue_extraction` æç¤ºè¯
   - åŸºäºç¬¬1æ¬¡çš„ç»“æœï¼Œç»§ç»­æå–é—æ¼çš„å®ä½“
   - é¿å…ä¸å·²æå–çš„å®ä½“é‡å¤
   - è¿”å›ï¼šè¡¥å……çš„å®ä½“åˆ—è¡¨

**æœ€ç»ˆç»“æœ**ï¼šå°†ä¸¤æ¬¡æå–çš„ç»“æœåˆå¹¶ï¼ˆ`final_result += glean_result`ï¼‰

---

### æå–æµç¨‹è¯¦è§£

#### ç¬¬1æ¬¡ï¼šåˆå§‹æå–

**æç¤ºè¯**: `PROMPTS["entity_extraction"]`

**åŠŸèƒ½**:
- ä»æ–‡æœ¬ä¸­è¯†åˆ«æ‰€æœ‰æ³•å¾‹ç›¸å…³å®ä½“
- æå–å®ä½“åç§°ã€ç±»å‹ã€æè¿°
- ä½¿ç”¨è§„å®šçš„è¾“å‡ºæ ¼å¼

**ç¤ºä¾‹è¾“å‡º**:
```
("entity"||"ã€Šä¸­åäººæ°‘å…±å’Œå›½æ°‘æ³•å…¸ã€‹"||"æ³•å¾‹æ³•è§„"||"ä¸­å›½æ°‘äº‹åŸºæœ¬æ³•...")##
("entity"||"æƒåˆ©èƒ½åŠ›"||"æ³•å¾‹æ¦‚å¿µ"||"æ°‘äº‹ä¸»ä½“äº«æœ‰æƒåˆ©...")##
###END###
```

---

#### ç¬¬2æ¬¡ï¼šè¡¥å……æå–ï¼ˆGleaningï¼‰

**æç¤ºè¯**: `PROMPTS["entiti_continue_extraction"]`

**åŠŸèƒ½**:
- åŸºäºç¬¬1æ¬¡çš„ç»“æœï¼Œç»§ç»­æå–é—æ¼çš„å®ä½“
- é¿å…ä¸å·²æå–çš„å®ä½“é‡å¤
- ä½¿ç”¨ç›¸åŒçš„è¾“å‡ºæ ¼å¼

**ä¸ºä»€ä¹ˆéœ€è¦è¡¥å……æå–**:
- LLM å¯èƒ½ä¸€æ¬¡æ— æ³•æå–æ‰€æœ‰å®ä½“
- é•¿æ–‡æœ¬å¯èƒ½é—æ¼éƒ¨åˆ†å®ä½“
- é€šè¿‡è¡¥å……æå–æé«˜å¬å›ç‡

---

### å¦‚æœä¿®æ”¹ `entity_extract_max_gleaning`

#### å¦‚æœè®¾ç½®ä¸º `entity_extract_max_gleaning=2`

**æ¯ä¸ª chunk çš„å®ä½“æå–æ¬¡æ•°ï¼šæœ€å¤š4æ¬¡**

1. **ç¬¬1æ¬¡**ï¼šåˆå§‹æå–
2. **ç¬¬2æ¬¡**ï¼šç¬¬1æ¬¡è¡¥å……æå–
3. **åˆ¤æ–­**ï¼šæ˜¯å¦éœ€è¦ç»§ç»­ï¼ˆè°ƒç”¨ `if_loop_prompt`ï¼‰
4. **ç¬¬3æ¬¡**ï¼šç¬¬2æ¬¡è¡¥å……æå–ï¼ˆå¦‚æœåˆ¤æ–­ä¸º"yes"ï¼‰
5. **åˆ¤æ–­**ï¼šæ˜¯å¦éœ€è¦ç»§ç»­
6. **ç¬¬4æ¬¡**ï¼šç¬¬3æ¬¡è¡¥å……æå–ï¼ˆå¦‚æœåˆ¤æ–­ä¸º"yes"ï¼‰

**æ³¨æ„**ï¼š
- æ¯æ¬¡è¡¥å……æå–åï¼Œéƒ½ä¼šåˆ¤æ–­æ˜¯å¦è¿˜éœ€è¦ç»§ç»­
- å¦‚æœ LLM å›ç­” "no"ï¼Œåˆ™åœæ­¢æå–
- å®é™…æå–æ¬¡æ•°å¯èƒ½å°‘äºæœ€å¤§å€¼

---

### å…³ç³»æå–çš„æ¬¡æ•°

**ä»£ç ä½ç½®**ï¼š`GraphExtraction/chunk.py` ç¬¬240-258è¡Œ

å…³ç³»æå–ä½¿ç”¨**ç›¸åŒçš„é€»è¾‘**ï¼š
- `entity_extract_max_gleaning=1`ï¼ˆè™½ç„¶åå­—æ˜¯entityï¼Œä½†å…³ç³»æå–ä¹Ÿç”¨å®ƒï¼‰
- **æ¯ä¸ª chunk çš„å…³ç³»æå–æ¬¡æ•°ï¼š2æ¬¡**
  1. ç¬¬1æ¬¡ï¼šåˆå§‹å…³ç³»æå–
  2. ç¬¬2æ¬¡ï¼šè¡¥å……å…³ç³»æå–

---

### æ€»LLMè°ƒç”¨æ¬¡æ•°ä¼°ç®—

å‡è®¾æœ‰ **N ä¸ª chunk**ï¼š

**å®ä½“æå–é˜¶æ®µ**:
- æ¯ä¸ª chunk: 2æ¬¡ LLM è°ƒç”¨
- æ€»è®¡: **N Ã— 2 = 2N æ¬¡**

**å…³ç³»æå–é˜¶æ®µ**:
- æ¯ä¸ª chunk: 2æ¬¡ LLM è°ƒç”¨
- æ€»è®¡: **N Ã— 2 = 2N æ¬¡**

**æ€»è®¡**: **4N æ¬¡ LLM è°ƒç”¨**

**ç¤ºä¾‹**:
- å¦‚æœæœ‰ 100 ä¸ª chunk
- å®ä½“æå–: 100 Ã— 2 = 200 æ¬¡
- å…³ç³»æå–: 100 Ã— 2 = 200 æ¬¡
- **æ€»è®¡: 400 æ¬¡ LLM è°ƒç”¨**

---

### ä¼˜åŒ–å»ºè®®

1. **å‡å°‘æå–æ¬¡æ•°**ï¼ˆå¦‚æœè´¨é‡è¶³å¤Ÿï¼‰:
   ```python
   entity_extract_max_gleaning = 0  # åªè¿›è¡Œåˆå§‹æå–ï¼Œä¸è¿›è¡Œè¡¥å……æå–
   ```
   - ä¼˜ç‚¹ï¼šå‡å°‘ LLM è°ƒç”¨æ¬¡æ•°ï¼Œæé«˜é€Ÿåº¦
   - ç¼ºç‚¹ï¼šå¯èƒ½é—æ¼éƒ¨åˆ†å®ä½“

2. **å¢åŠ æå–æ¬¡æ•°**ï¼ˆå¦‚æœéœ€è¦æ›´é«˜å¬å›ç‡ï¼‰:
   ```python
   entity_extract_max_gleaning = 2  # è¿›è¡Œ2æ¬¡è¡¥å……æå–
   ```
   - ä¼˜ç‚¹ï¼šæé«˜å®ä½“å¬å›ç‡
   - ç¼ºç‚¹ï¼šå¢åŠ  LLM è°ƒç”¨æ¬¡æ•°ï¼Œå¤„ç†æ—¶é—´æ›´é•¿

3. **åŠ¨æ€åˆ¤æ–­**:
   - å½“å‰ä»£ç åœ¨ `max_gleaning > 1` æ—¶ä¼šåŠ¨æ€åˆ¤æ–­æ˜¯å¦éœ€è¦ç»§ç»­
   - å¦‚æœ LLM è®¤ä¸ºæ²¡æœ‰é—æ¼çš„å®ä½“ï¼Œä¼šè‡ªåŠ¨åœæ­¢

---

### å…³é”®ä»£ç ä½ç½®

| åŠŸèƒ½ | ä»£ç ä½ç½® | æå–æ¬¡æ•° |
|------|---------|---------|
| å®ä½“æå– | `chunk.py` ç¬¬136-210è¡Œ | 2æ¬¡ï¼ˆå½“å‰é…ç½®ï¼‰ |
| å…³ç³»æå– | `chunk.py` ç¬¬225-300è¡Œ | 2æ¬¡ï¼ˆå½“å‰é…ç½®ï¼‰ |
| æœ€å¤§è¡¥å……æ¬¡æ•° | `chunk.py` ç¬¬150è¡Œ | `entity_extract_max_gleaning=1` |

---

## ğŸ”— å®ä½“å’Œå…³ç³»çš„å…³è”æœºåˆ¶

### å…³è”æ–¹å¼

å®ä½“å’Œå…³ç³»é€šè¿‡**å®ä½“åç§°ï¼ˆentity_nameï¼‰**è¿›è¡Œå…³è”ï¼Œè¿™æ˜¯ä¸€ç§**åŸºäºåç§°çš„å¼•ç”¨**æ–¹å¼ï¼Œè€Œéä¼ ç»Ÿçš„å¤–é”®IDå…³è”ã€‚

---

### æ•°æ®ç»“æ„

#### 1. å®ä½“ï¼ˆEntityï¼‰ç»“æ„

**å­˜å‚¨ä½ç½®**:
- JSONæ–‡ä»¶: `entity.jsonl`
- MySQLè¡¨: `entities`
- Milvuså‘é‡åº“: `entity_collection`

**æ•°æ®æ ¼å¼**:
```json
{
  "entity_name": "åŠ³åŠ¨åˆåŒ",           // ä¸»é”®/å”¯ä¸€æ ‡è¯†
  "description": "åŠ³åŠ¨è€…ä¸ç”¨äººå•ä½ç¡®ç«‹åŠ³åŠ¨å…³ç³»...",
  "entity_type": "æ³•å¾‹æ¦‚å¿µ",
  "source_id": "hash_code_1",
  "parent": "åŠ³åŠ¨æ³•å¾‹å…³ç³»",
  "level": 0
}
```

---

#### 2. å…³ç³»ï¼ˆRelationï¼‰ç»“æ„

**å­˜å‚¨ä½ç½®**:
- JSONæ–‡ä»¶: `relation.jsonl`
- MySQLè¡¨: `relations`

**æ•°æ®æ ¼å¼**:
```json
{
  "src_id": "åŠ³åŠ¨åˆåŒ",              // æºå®ä½“åç§°ï¼ˆå¼•ç”¨entity_nameï¼‰
  "tgt_id": "å·¥èµ„",                  // ç›®æ ‡å®ä½“åç§°ï¼ˆå¼•ç”¨entity_nameï¼‰
  "description": "åŠ³åŠ¨åˆåŒè§„å®šäº†å·¥èµ„æ”¯ä»˜æ ‡å‡†...",
  "weight": 8.0,
  "source_id": "hash_code_1"
}
```

**MySQLå­˜å‚¨æ ¼å¼**:
```sql
-- relationsè¡¨ç»“æ„
CREATE TABLE relations (
  src_tgt VARCHAR(190),         -- æºå®ä½“åç§°ï¼ˆå¯¹åº”entity_nameï¼‰
  tgt_src VARCHAR(190),         -- ç›®æ ‡å®ä½“åç§°ï¼ˆå¯¹åº”entity_nameï¼‰
  description VARCHAR(10000),   -- å…³ç³»æè¿°
  weight INT,                    -- å…³ç³»æƒé‡
  level INT,                     -- å±‚çº§
  INDEX link(src_tgt, tgt_src)   -- ç´¢å¼•
);
```

---

### å…³è”æœºåˆ¶è¯¦è§£

#### 1. åŸºäºåç§°çš„å¼•ç”¨

**å…³é”®ç‚¹**:
- âœ… **ç›´æ¥å¼•ç”¨**: å…³ç³»ä¸­çš„ `src_id`/`tgt_id` ç›´æ¥å­˜å‚¨å®ä½“åç§°ï¼Œä¸æ˜¯ID
- âœ… **åç§°åŒ¹é…**: é€šè¿‡å­—ç¬¦ä¸²åŒ¹é…æ‰¾åˆ°å¯¹åº”çš„å®ä½“
- âœ… **åŒå‘å­˜å‚¨**: MySQLä¸­åŒæ—¶å­˜å‚¨ `src_tgt` å’Œ `tgt_src`ï¼Œæ”¯æŒåŒå‘æŸ¥è¯¢

**ç¤ºä¾‹**:
```python
# å®ä½“
entity = {
    "entity_name": "åŠ³åŠ¨åˆåŒ",  # è¿™æ˜¯å”¯ä¸€æ ‡è¯†
    "description": "..."
}

# å…³ç³»ï¼ˆé€šè¿‡å®ä½“åç§°å¼•ç”¨ï¼‰
relation = {
    "src_id": "åŠ³åŠ¨åˆåŒ",      # å¼•ç”¨ä¸Šé¢çš„entity_name
    "tgt_id": "å·¥èµ„",          # å¼•ç”¨å¦ä¸€ä¸ªå®ä½“çš„entity_name
    "description": "..."
}
```

---

#### 2. æŸ¥è¯¢å…³è”æ–¹å¼

**å‡½æ•°**: `search_nodes_link(entity1, entity2, working_dir)`

**æŸ¥è¯¢é€»è¾‘**:
```python
def search_nodes_link(entity1, entity2, working_dir):
    """
    æŸ¥è¯¢ä¸¤ä¸ªå®ä½“ä¹‹é—´çš„å…³ç³»
    
    å‚æ•°:
        entity1: æºå®ä½“åç§°
        entity2: ç›®æ ‡å®ä½“åç§°
        working_dir: å·¥ä½œç›®å½•ï¼ˆç”¨äºç¡®å®šæ•°æ®åº“åï¼‰
    
    è¿”å›:
        å…³ç³»è®°å½•: (src_tgt, tgt_src, description, weight, level)
    """
    db = get_mysql_connection()
    db_name = os.path.basename(working_dir)
    
    # 1. å°è¯•æ­£å‘æŸ¥è¯¢: entity1 -> entity2
    sql = f"SELECT * FROM {db_name}.relations WHERE src_tgt=%s AND tgt_src=%s"
    cursor.execute(sql, (entity1, entity2))
    ret = cursor.fetchall()
    
    # 2. å¦‚æœæ­£å‘æŸ¥è¯¢å¤±è´¥ï¼Œå°è¯•åå‘æŸ¥è¯¢: entity2 -> entity1
    if len(ret) == 0:
        sql = f"SELECT * FROM {db_name}.relations WHERE src_tgt=%s AND tgt_src=%s"
        cursor.execute(sql, (entity2, entity1))
        ret = cursor.fetchall()
    
    if len(ret) == 0:
        return None  # æ²¡æœ‰æ‰¾åˆ°å…³ç³»
    else:
        return ret[0]  # è¿”å›å…³ç³»è®°å½•
```

**å…³é”®ç‚¹**:
- âœ… **åŒå‘æŸ¥è¯¢**: æ”¯æŒ `A->B` å’Œ `B->A` ä¸¤ç§æ–¹å‘
- âœ… **åç§°åŒ¹é…**: ç›´æ¥é€šè¿‡å®ä½“åç§°å­—ç¬¦ä¸²åŒ¹é…
- âœ… **ç´¢å¼•ä¼˜åŒ–**: `src_tgt` å’Œ `tgt_src` å­—æ®µæœ‰è”åˆç´¢å¼•ï¼ŒæŸ¥è¯¢é€Ÿåº¦å¿«

---

#### 3. åœ¨æ¨ç†è·¯å¾„ä¸­çš„åº”ç”¨

**å‡½æ•°**: `get_reasoning_chain(working_dir, entities_set)`

**æµç¨‹**:
```python
# 1. å¯¹æ¯å¯¹å®ä½“ï¼ŒæŸ¥æ‰¾å®ƒä»¬ä¹‹é—´çš„å…³ç³»
maybe_edges = list(combinations(entities_set, 2))
# ä¾‹å¦‚: [("åŠ³åŠ¨åˆåŒ", "å·¥èµ„"), ("åŠ³åŠ¨åˆåŒ", "å·¥ä½œæ—¶é—´"), ...]

# 2. å¯¹æ¯å¯¹å®ä½“ï¼ŒæŸ¥è¯¢å…³ç³»
for edge in maybe_edges:
    node1, node2 = edge[0], edge[1]
    
    # 3. æŸ¥è¯¢å…³ç³»ï¼ˆé€šè¿‡å®ä½“åç§°ï¼‰
    information = search_nodes_link(node1, node2, working_dir)
    # è¿”å›: (src_tgt, tgt_src, description, weight, level)
    
    if information:
        # information[2] æ˜¯å…³ç³»æè¿°
        reasoning_path_information.append([node1, node2, information[2]])
```

**ç¤ºä¾‹**:
```python
# æŸ¥è¯¢ "åŠ³åŠ¨åˆåŒ" å’Œ "å·¥èµ„" ä¹‹é—´çš„å…³ç³»
relation = search_nodes_link("åŠ³åŠ¨åˆåŒ", "å·¥èµ„", working_dir)
# è¿”å›: ("åŠ³åŠ¨åˆåŒ", "å·¥èµ„", "åŠ³åŠ¨åˆåŒè§„å®šäº†å·¥èµ„æ”¯ä»˜æ ‡å‡†...", 8, 0)

# å…³ç³»æè¿°ä¼šè¢«æ·»åŠ åˆ°æ¨ç†è·¯å¾„ä¿¡æ¯ä¸­
reasoning_path_information.append([
    "åŠ³åŠ¨åˆåŒ", 
    "å·¥èµ„", 
    "åŠ³åŠ¨åˆåŒè§„å®šäº†å·¥èµ„æ”¯ä»˜æ ‡å‡†..."
])
```

---

### å…³è”å…³ç³»å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å®ä½“è¡¨(entities)â”‚
â”‚                 â”‚
â”‚ entity_name     â”‚ â†â”€â”€â”
â”‚ description     â”‚    â”‚
â”‚ source_id       â”‚    â”‚
â”‚ parent          â”‚    â”‚
â”‚ level           â”‚    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
                        â”‚
                        â”‚ é€šè¿‡å®ä½“åç§°å¼•ç”¨
                        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚ å…³ç³»è¡¨(relations)â”‚    â”‚
â”‚                 â”‚    â”‚
â”‚ src_tgt â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”˜ (å¼•ç”¨entity_name)
â”‚ tgt_src â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â” (å¼•ç”¨entity_name)
â”‚ description     â”‚    â”‚
â”‚ weight          â”‚    â”‚
â”‚ level           â”‚    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
                        â”‚
                        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  å®ä½“è¡¨(entities)â”‚    â”‚
â”‚                 â”‚    â”‚
â”‚ entity_name     â”‚ â†â”€â”€â”˜
â”‚ description     â”‚
â”‚ ...
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### å®é™…ç¤ºä¾‹

#### å®ä½“æ•°æ®
```json
// entity.jsonl
{"entity_name": "åŠ³åŠ¨åˆåŒ", "description": "åŠ³åŠ¨è€…ä¸ç”¨äººå•ä½ç¡®ç«‹åŠ³åŠ¨å…³ç³»...", ...}
{"entity_name": "å·¥èµ„", "description": "åŠ³åŠ¨è€…å› æä¾›åŠ³åŠ¨è€Œè·å¾—çš„æŠ¥é…¬...", ...}
```

#### å…³ç³»æ•°æ®
```json
// relation.jsonl
{"src_id": "åŠ³åŠ¨åˆåŒ", "tgt_id": "å·¥èµ„", "description": "åŠ³åŠ¨åˆåŒè§„å®šäº†å·¥èµ„æ”¯ä»˜æ ‡å‡†...", ...}
```

#### å…³è”æŸ¥è¯¢
```python
# æŸ¥è¯¢ "åŠ³åŠ¨åˆåŒ" å’Œ "å·¥èµ„" ä¹‹é—´çš„å…³ç³»
relation = search_nodes_link("åŠ³åŠ¨åˆåŒ", "å·¥èµ„", working_dir)

# SQLæŸ¥è¯¢ï¼ˆå®é™…æ‰§è¡Œï¼‰
SELECT * FROM relations 
WHERE src_tgt='åŠ³åŠ¨åˆåŒ' AND tgt_src='å·¥èµ„'
# æˆ–
SELECT * FROM relations 
WHERE src_tgt='å·¥èµ„' AND tgt_src='åŠ³åŠ¨åˆåŒ'

# è¿”å›ç»“æœ
("åŠ³åŠ¨åˆåŒ", "å·¥èµ„", "åŠ³åŠ¨åˆåŒè§„å®šäº†å·¥èµ„æ”¯ä»˜æ ‡å‡†...", 8, 0)
```

---

### å…³è”ç‰¹ç‚¹

1. **åŸºäºåç§°çš„å¼•ç”¨**:
   - âœ… ç®€å•ç›´è§‚ï¼Œä¸éœ€è¦ç»´æŠ¤å¤–é”®
   - âœ… å®ä½“åç§°å°±æ˜¯å”¯ä¸€æ ‡è¯†
   - âš ï¸ éœ€è¦ç¡®ä¿å®ä½“åç§°çš„ä¸€è‡´æ€§

2. **åŒå‘æŸ¥è¯¢æ”¯æŒ**:
   - âœ… åŒæ—¶å­˜å‚¨ `src_tgt` å’Œ `tgt_src`
   - âœ… æ”¯æŒ `A->B` å’Œ `B->A` ä¸¤ç§æŸ¥è¯¢æ–¹å‘
   - âœ… ç´¢å¼•ä¼˜åŒ–ï¼ŒæŸ¥è¯¢é€Ÿåº¦å¿«

3. **å±‚çº§æ”¯æŒ**:
   - âœ… å…³ç³»ä¹Ÿæœ‰ `level` å­—æ®µï¼Œæ”¯æŒä¸åŒå±‚çº§çš„å…³ç³»
   - âœ… åŸå§‹å…³ç³»ï¼ˆlevel=0ï¼‰å’Œèšåˆå…³ç³»ï¼ˆlevel>0ï¼‰

4. **å¯è¿½æº¯æ€§**:
   - âœ… å…³ç³»ä¹Ÿæœ‰ `source_id`ï¼Œå¯ä»¥è¿½æº¯åˆ°åŸå§‹æ–‡æœ¬å—
   - âœ… é€šè¿‡ `weight` å­—æ®µå¯ä»¥è¯„ä¼°å…³ç³»å¼ºåº¦

---

### æŸ¥è¯¢æ—¶çš„å…³è”æµç¨‹

```
1. å‘é‡æ£€ç´¢å¾—åˆ°å®ä½“åˆ—è¡¨
   ["åŠ³åŠ¨åˆåŒ", "å·¥èµ„", "å·¥ä½œæ—¶é—´", ...]
   
2. æ„å»ºå®ä½“å¯¹
   [("åŠ³åŠ¨åˆåŒ", "å·¥èµ„"), ("åŠ³åŠ¨åˆåŒ", "å·¥ä½œæ—¶é—´"), ...]
   
3. å¯¹æ¯ä¸ªå®ä½“å¯¹ï¼ŒæŸ¥è¯¢å…³ç³»
   search_nodes_link("åŠ³åŠ¨åˆåŒ", "å·¥èµ„", working_dir)
   â†’ ä»MySQL relationsè¡¨æŸ¥è¯¢
   â†’ è¿”å›å…³ç³»æè¿°
   
4. ç»„ç»‡æ¨ç†è·¯å¾„ä¿¡æ¯
   reasoning_path_info = "åŠ³åŠ¨åˆåŒè§„å®šäº†å·¥èµ„æ”¯ä»˜æ ‡å‡†...\nå·¥ä½œæ—¶é—´ç”±åŠ³åŠ¨åˆåŒçº¦å®š..."
```

---

## ğŸŒ³ å±‚æ¬¡æ ‘å­˜å‚¨æ–¹å¼è¯¦è§£

### å­˜å‚¨æ ¼å¼

å±‚æ¬¡æ ‘é‡‡ç”¨**åˆ†å±‚åˆ—è¡¨ + çˆ¶å­å…³ç³»**çš„æ–¹å¼å­˜å‚¨ï¼Œæ”¯æŒä¸¤ç§å­˜å‚¨æ ¼å¼ï¼š

#### 1. JSONæ–‡ä»¶æ ¼å¼ (`all_entities.json`)

**æ–‡ä»¶æ ¼å¼**: JSONLï¼ˆæ¯è¡Œä¸€ä¸ªJSONå¯¹è±¡ï¼‰

**æ•°æ®ç»“æ„**: 
```python
# all_entities æ˜¯ä¸€ä¸ªåˆ—è¡¨ï¼Œæ¯ä¸ªå…ƒç´ ä»£è¡¨ä¸€ä¸ªå±‚çº§
all_entities = [
    # Level 0: åŸå§‹å®ä½“å±‚ï¼ˆåˆ—è¡¨ï¼‰
    [
        {
            "entity_name": "åŠ³åŠ¨åˆåŒ",
            "description": "...",
            "entity_type": "æ³•å¾‹æ¦‚å¿µ",
            "source_id": "chunk_1|chunk_2",
            "parent": "åŠ³åŠ¨æ³•å¾‹å…³ç³»",  # æŒ‡å‘çˆ¶èŠ‚ç‚¹
            "level": 0,                # å±‚çº§ï¼ˆ0=åŸå§‹èŠ‚ç‚¹ï¼‰
            "degree": 5                # åº¦æ•°ï¼ˆè¿æ¥æ•°ï¼‰
        },
        ...
    ],
    # Level 1: ç¬¬ä¸€å±‚èšåˆèŠ‚ç‚¹ï¼ˆåˆ—è¡¨ï¼‰
    [
        {
            "entity_name": "åŠ³åŠ¨æ³•å¾‹å…³ç³»",
            "description": "...",
            "parent": "åŠ³åŠ¨æ³•ä½“ç³»",    # æŒ‡å‘æ›´é«˜å±‚çº§çš„çˆ¶èŠ‚ç‚¹
            "level": 1,
            ...
        },
        ...
    ],
    # Level 2: ç¬¬äºŒå±‚èšåˆèŠ‚ç‚¹
    [...],
    # ...
    # é¡¶å±‚èŠ‚ç‚¹ï¼ˆå•ä¸ªå­—å…¸ï¼Œä¸æ˜¯åˆ—è¡¨ï¼‰
    {
        "entity_name": "root",         # æˆ–é¡¶å±‚ç¤¾åŒºåç§°
        "description": "...",
        "parent": "root",              # é¡¶å±‚èŠ‚ç‚¹çš„parentæ˜¯'root'
        "level": N,                    # æœ€é«˜å±‚çº§
        ...
    }
]
```

**å…³é”®ç‰¹ç‚¹**:
- **åˆ†å±‚å­˜å‚¨**: æ¯ä¸€å±‚æ˜¯ä¸€ä¸ªåˆ—è¡¨ï¼ŒåŒ…å«è¯¥å±‚çš„æ‰€æœ‰å®ä½“
- **çˆ¶å­å…³ç³»**: é€šè¿‡ `parent` å­—æ®µæŒ‡å‘çˆ¶èŠ‚ç‚¹
- **å±‚çº§æ ‡è¯†**: `level` å­—æ®µæ ‡è¯†èŠ‚ç‚¹æ‰€åœ¨å±‚çº§ï¼ˆ0=åŸå§‹èŠ‚ç‚¹ï¼Œ>0=èšåˆèŠ‚ç‚¹ï¼‰
- **é¡¶å±‚èŠ‚ç‚¹**: å¦‚æœåªæœ‰1ä¸ªé¡¶å±‚èŠ‚ç‚¹ï¼Œå®ƒçš„ `parent` è®¾ä¸º `'root'`

**ä¿å­˜æ–¹å¼**:
```python
# ä½¿ç”¨ write_jsonl_force ä¿å­˜
write_jsonl_force(all_entities, f"{WORKING_DIR}/all_entities.json")

# ä¿å­˜åçš„æ–‡ä»¶æ ¼å¼ï¼ˆJSONLï¼‰:
# {"entity_name": "åŠ³åŠ¨åˆåŒ", "parent": "åŠ³åŠ¨æ³•å¾‹å…³ç³»", "level": 0, ...}
# {"entity_name": "åŠ³åŠ¨åˆåŒ", "parent": "åŠ³åŠ¨æ³•å¾‹å…³ç³»", "level": 0, ...}
# ...
# {"entity_name": "åŠ³åŠ¨æ³•å¾‹å…³ç³»", "parent": "åŠ³åŠ¨æ³•ä½“ç³»", "level": 1, ...}
# ...
# {"entity_name": "root", "parent": "root", "level": 5, ...}
```

---

#### 2. MySQLæ•°æ®åº“æ ¼å¼

**è¡¨ç»“æ„**: `entities` è¡¨

```sql
CREATE TABLE entities (
  entity_name VARCHAR(500),      -- å®ä½“åç§°ï¼ˆä¸»é”®ï¼‰
  description VARCHAR(10000),     -- å®ä½“æè¿°
  source_id VARCHAR(1000),       -- æ¥æºchunk IDs
  degree INT,                     -- åº¦æ•°ï¼ˆè¿æ¥æ•°ï¼‰
  parent VARCHAR(1000),           -- çˆ¶èŠ‚ç‚¹åç§°ï¼ˆå…³é”®å­—æ®µï¼‰
  level INT,                      -- å±‚çº§
  INDEX en(entity_name)           -- ç´¢å¼•
);
```

**å­˜å‚¨æ–¹å¼**:
- æ‰€æœ‰å±‚çº§çš„å®ä½“éƒ½å­˜å‚¨åœ¨åŒä¸€ä¸ªè¡¨ä¸­
- é€šè¿‡ `parent` å­—æ®µå»ºç«‹çˆ¶å­å…³ç³»
- é€šè¿‡ `level` å­—æ®µåŒºåˆ†å±‚çº§

**æ’å…¥é€»è¾‘**:
```python
# ä» all_entities.json è¯»å–å¹¶æ’å…¥MySQL
for level, entity_line in enumerate(all_entities):
    if type(entity_line) is not list:
        # å•ä¸ªé¡¶å±‚èŠ‚ç‚¹
        entity = entity_line
        insert_entity(entity, level)
    else:
        # åˆ—è¡¨å½¢å¼çš„å±‚çº§
        for entity in entity_line:
            insert_entity(entity, level)
```

---

### æ ‘ç»“æ„é‡å»º

#### ä»å­èŠ‚ç‚¹åˆ°æ ¹èŠ‚ç‚¹çš„è·¯å¾„æŸ¥æ‰¾

**å‡½æ•°**: `find_tree_root(working_dir, entity)`

**å®ç°é€»è¾‘**:
```python
def find_tree_root(working_dir, entity):
    """
    ä»ç»™å®šå®ä½“å¼€å§‹ï¼Œå‘ä¸ŠæŸ¥æ‰¾ç›´åˆ°æ ¹èŠ‚ç‚¹
    è¿”å›: [entity, parent1, parent2, ..., root]
    """
    res = [entity]  # ç»“æœåˆ—è¡¨ï¼Œä»å­èŠ‚ç‚¹åˆ°æ ¹èŠ‚ç‚¹
    depth = get_max_level(working_dir)  # è·å–æœ€å¤§å±‚çº§
    
    current_entity = entity
    for i in range(depth):
        # æŸ¥è¯¢å½“å‰å®ä½“çš„çˆ¶èŠ‚ç‚¹
        parent = query_parent(current_entity)
        if not parent:
            break
        res.append(parent)
        current_entity = parent  # ç»§ç»­å‘ä¸ŠæŸ¥æ‰¾
    
    return res  # è¿”å›è·¯å¾„ï¼š[å­èŠ‚ç‚¹, çˆ¶èŠ‚ç‚¹1, çˆ¶èŠ‚ç‚¹2, ..., æ ¹èŠ‚ç‚¹]
```

**ç¤ºä¾‹**:
```python
# æŸ¥è¯¢ "åŠ³åŠ¨åˆåŒ" åˆ°æ ¹èŠ‚ç‚¹çš„è·¯å¾„
path = find_tree_root(working_dir, "åŠ³åŠ¨åˆåŒ")
# è¿”å›: ["åŠ³åŠ¨åˆåŒ", "åŠ³åŠ¨æ³•å¾‹å…³ç³»", "åŠ³åŠ¨æ³•ä½“ç³»", "root"]
```

---

#### ä¸¤ä¸ªèŠ‚ç‚¹ä¹‹é—´çš„è·¯å¾„æŸ¥æ‰¾

**å‡½æ•°**: `find_path(entity1, entity2, working_dir, level, depth=5)`

**å®ç°é€»è¾‘**:
```sql
-- ä½¿ç”¨MySQLçš„é€’å½’CTEï¼ˆCommon Table Expressionï¼‰
WITH RECURSIVE path_cte AS (
    -- èµ·å§‹èŠ‚ç‚¹
    SELECT src_tgt, tgt_src, path, 1 AS depth
    FROM relations
    WHERE src_tgt = entity1 AND level = level
    
    UNION ALL
    
    -- é€’å½’æŸ¥æ‰¾è·¯å¾„
    SELECT p.src_tgt, t.tgt_src, CONCAT(p.path, '|', t.tgt_src), p.depth + 1
    FROM path_cte p
    JOIN relations t ON p.tgt_src = t.src_tgt
    WHERE level = level AND p.depth < max_depth
)
SELECT path FROM path_cte WHERE tgt_src = entity2
```

---

### æ ‘ç»“æ„ç‰¹ç‚¹

1. **å€’ç½®æ ‘ç»“æ„**:
   - å­èŠ‚ç‚¹é€šè¿‡ `parent` å­—æ®µæŒ‡å‘çˆ¶èŠ‚ç‚¹
   - ä¸æ˜¯ä¼ ç»Ÿçš„"çˆ¶èŠ‚ç‚¹åŒ…å«å­èŠ‚ç‚¹åˆ—è¡¨"çš„ç»“æ„
   - ä¼˜ç‚¹ï¼šæŸ¥è¯¢çµæ´»ï¼Œå¯ä»¥ä»ä»»æ„èŠ‚ç‚¹å‘ä¸Šæˆ–å‘ä¸‹éå†

2. **å¤šå±‚çº§èšåˆ**:
   - Level 0: åŸå§‹å®ä½“ï¼ˆç›´æ¥ä»æ–‡æœ¬æå–ï¼‰
   - Level 1-N: èšåˆèŠ‚ç‚¹ï¼ˆé€šè¿‡å±‚æ¬¡èšç±»ç”Ÿæˆï¼‰
   - æ¯ä¸€å±‚éƒ½æ˜¯å¯¹ä¸‹ä¸€å±‚çš„æŠ½è±¡å’Œèšåˆ

3. **åŠ¨æ€å±‚çº§**:
   - å±‚çº§æ•°é‡å–å†³äºèšç±»ç»“æœ
   - é¡¶å±‚èŠ‚ç‚¹å¯èƒ½åªæœ‰ä¸€ä¸ªï¼ˆ`parent='root'`ï¼‰
   - ä¹Ÿå¯èƒ½æœ‰å¤šä¸ªé¡¶å±‚èŠ‚ç‚¹ï¼ˆæ¯ä¸ªéƒ½æ˜¯ç‹¬ç«‹çš„ç¤¾åŒºï¼‰

4. **å…³ç³»å­˜å‚¨**:
   - å…³ç³»ä¹ŸæŒ‰å±‚çº§å­˜å‚¨ï¼ˆ`relations` è¡¨çš„ `level` å­—æ®µï¼‰
   - åŒä¸€å±‚çº§å†…çš„å®ä½“æ‰æœ‰ç›´æ¥å…³ç³»
   - è·¨å±‚çº§å…³ç³»é€šè¿‡è·¯å¾„æŸ¥æ‰¾å®ç°

---

### å­˜å‚¨ä½ç½®æ€»ç»“

| å­˜å‚¨ä½ç½® | æ ¼å¼ | ç”¨é€” | è®¿é—®æ–¹å¼ |
|---------|------|------|---------|
| `all_entities.json` | JSONL | å®Œæ•´å±‚æ¬¡ç»“æ„ï¼ˆå«å‘é‡ï¼‰ | æ–‡ä»¶è¯»å– |
| MySQL `entities` è¡¨ | å…³ç³»è¡¨ | ç»“æ„åŒ–æŸ¥è¯¢ã€è·¯å¾„æŸ¥æ‰¾ | SQLæŸ¥è¯¢ |
| Milvus `entity_collection` | å‘é‡åº“ | è¯­ä¹‰æ£€ç´¢ | å‘é‡æœç´¢ |

---

## ğŸ“ source_id å­—æ®µè¯¦è§£

### å­˜å‚¨å†…å®¹

`source_id` å­—æ®µå­˜å‚¨çš„æ˜¯**æ–‡æœ¬å—ï¼ˆchunkï¼‰çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼ˆhash_codeï¼‰**ï¼Œç”¨äºè¿½è¸ªå®ä½“å’Œå…³ç³»æ˜¯ä»å“ªäº›åŸå§‹æ–‡æœ¬å—ä¸­æå–å‡ºæ¥çš„ã€‚

### æ ¼å¼è¯´æ˜

#### 1. å•ä¸ªå®ä½“ï¼ˆLevel 0 - åŸå§‹èŠ‚ç‚¹ï¼‰

**æ ¼å¼**: å•ä¸ª hash_code å­—ç¬¦ä¸²

**ç¤ºä¾‹**:
```json
{
  "entity_name": "åŠ³åŠ¨åˆåŒ",
  "source_id": "aec36081729a1f2cdc364b13842217ae"
}
```

**å«ä¹‰**: è¯¥å®ä½“æ˜¯ä» `hash_code` ä¸º `aec36081729a1f2cdc364b13842217ae` çš„æ–‡æœ¬å—ä¸­æå–çš„ã€‚

---

#### 2. èšåˆå®ä½“ï¼ˆLevel > 0 - èšåˆèŠ‚ç‚¹ï¼‰

**æ ¼å¼**: å¤šä¸ª hash_code ç”¨ `|` åˆ†éš”

**ç¤ºä¾‹**:
```json
{
  "entity_name": "æ³•å¾‹å®æ–½ä½“ç³»",
  "source_id": "aec36081729a1f2cdc364b13842217ae|559e6fe046d22c9f63a1d5d3e4c5aac7|33a2a0ecef1e7df9399081879b50d439|..."
}
```

**å«ä¹‰**: è¯¥èšåˆå®ä½“æ˜¯ä»å¤šä¸ªæ–‡æœ¬å—ä¸­æå–çš„ï¼ŒåŒ…å«äº†æ‰€æœ‰ç›¸å…³ chunk çš„ `hash_code`ã€‚

**ç”Ÿæˆé€»è¾‘**:
```python
# åœ¨å±‚æ¬¡èšç±»æ—¶ï¼Œåˆå¹¶æ‰€æœ‰å­èŠ‚ç‚¹çš„ source_id
data['source_id'] = "|".join(set([n['source_id'] for n in cluster_nodes]))
```

---

### æ•°æ®æµè½¬è¿‡ç¨‹

#### é˜¶æ®µ1: å®ä½“æå–ï¼ˆ`law_extract_graphrag.py`ï¼‰

```python
# 1. ä» chunk JSON æ–‡ä»¶è¯»å–
chunks = {
    "hash_code_1": "æ–‡æœ¬å†…å®¹1",
    "hash_code_2": "æ–‡æœ¬å†…å®¹2",
    ...
}

# 2. æå–å®ä½“æ—¶ï¼Œsource_id = chunk_key (å³ hash_code)
entity = {
    "entity_name": "åŠ³åŠ¨åˆåŒ",
    "source_id": "hash_code_1"  # å•ä¸ª hash_code
}
```

---

#### é˜¶æ®µ2: å±‚æ¬¡èšç±»ï¼ˆ`build_law_graph.py`ï¼‰

```python
# èšåˆå¤šä¸ªå®ä½“æ—¶ï¼Œåˆå¹¶æ‰€æœ‰ source_id
cluster_nodes = [
    {"entity_name": "å®ä½“1", "source_id": "hash_code_1"},
    {"entity_name": "å®ä½“2", "source_id": "hash_code_2"},
    {"entity_name": "å®ä½“3", "source_id": "hash_code_3|hash_code_4"}
]

# åˆå¹¶åçš„ source_id
aggregated_entity = {
    "entity_name": "èšåˆå®ä½“",
    "source_id": "hash_code_1|hash_code_2|hash_code_3|hash_code_4"
}
```

---

#### é˜¶æ®µ3: å­˜å‚¨åˆ° MySQLï¼ˆ`database_utils.py`ï¼‰

**é™åˆ¶**: ç”±äº MySQL å­—æ®µé•¿åº¦é™åˆ¶ï¼ˆ`VARCHAR(1000)`ï¼‰ï¼Œåªä¿ç•™å‰5ä¸ª `hash_code`ï¼š

```python
# æ’å…¥ MySQL æ—¶ï¼Œé™åˆ¶ source_id é•¿åº¦
source_id = "|".join(entity.get('source_id', '').split("|")[:5])
```

**ç¤ºä¾‹**:
- **åŸå§‹**: `hash_1|hash_2|hash_3|hash_4|hash_5|hash_6|hash_7`
- **å­˜å‚¨**: `hash_1|hash_2|hash_3|hash_4|hash_5`ï¼ˆåªä¿ç•™å‰5ä¸ªï¼‰

---

### hash_code çš„æ¥æº

`hash_code` æ˜¯åœ¨**æ–‡æœ¬åˆ†å—é˜¶æ®µ**ï¼ˆ`law_data_chunk.py`ï¼‰ç”Ÿæˆçš„ï¼Œæ¯ä¸ªæ–‡æœ¬å—éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„ `hash_code`ï¼š

```json
// chunk JSON æ–‡ä»¶æ ¼å¼
[
  {
    "hash_code": "aec36081729a1f2cdc364b13842217ae",
    "text": "æ³•å¾‹æ¡æ–‡å†…å®¹...",
    "metadata": {...}
  },
  {
    "hash_code": "559e6fe046d22c9f63a1d5d3e4c5aac7",
    "text": "å¦ä¸€æ®µæ³•å¾‹æ¡æ–‡...",
    "metadata": {...}
  }
]
```

---

### ç”¨é€”

1. **å¯è¿½æº¯æ€§**: å¯ä»¥è¿½è¸ªå®ä½“/å…³ç³»æ¥è‡ªå“ªäº›åŸå§‹æ–‡æœ¬å—
2. **å»é‡**: é€šè¿‡ `hash_code` å¯ä»¥è¯†åˆ«é‡å¤çš„æ–‡æœ¬å—
3. **è¯æ®æ”¯æŒ**: åœ¨æŸ¥è¯¢æ—¶ï¼Œå¯ä»¥é€šè¿‡ `source_id` æ‰¾åˆ°åŸå§‹æ–‡æœ¬ä½œä¸ºè¯æ®
4. **æ•°æ®è´¨é‡**: äº†è§£å®ä½“/å…³ç³»çš„æ¥æºåˆ†å¸ƒï¼ˆæ¥è‡ªå¤šå°‘ä¸ªä¸åŒçš„æ–‡æœ¬å—ï¼‰

---

### å®é™…ç¤ºä¾‹

ä»æ‚¨æä¾›çš„ `all_entities.json` æ–‡ä»¶ä¸­ï¼š

```json
{
  "entity_name": "æ³•å¾‹å®æ–½ä½“ç³»",
  "source_id": "aec36081729a1f2cdc364b13842217ae|559e6fe046d22c9f63a1d5d3e4c5aac7|33a2a0ecef1e7df9399081879b50d439|8ebf84a350c2b7af58a73a9831b4e69a|fea21605d7267cd0986ca5c6c4167214|..."
}
```

**è§£è¯»**:
- è¯¥èšåˆå®ä½“æ¥è‡ª**12ä¸ªä¸åŒçš„æ–‡æœ¬å—**
- æ¯ä¸ª `hash_code` å¯¹åº”ä¸€ä¸ªåŸå§‹æ–‡æœ¬å—
- å¯ä»¥é€šè¿‡è¿™äº› `hash_code` åœ¨ chunk æ–‡ä»¶ä¸­æ‰¾åˆ°åŸå§‹æ–‡æœ¬å†…å®¹

---

### æ³¨æ„äº‹é¡¹

1. **MySQL å­˜å‚¨é™åˆ¶**: 
   - å­—æ®µç±»å‹ï¼š`VARCHAR(1000)`
   - å®é™…å­˜å‚¨ï¼šåªä¿ç•™å‰5ä¸ª `hash_code`
   - å®Œæ•´æ•°æ®ï¼šä¿å­˜åœ¨ `all_entities.json` æ–‡ä»¶ä¸­

2. **å»é‡å¤„ç†**:
   - åœ¨åˆå¹¶æ—¶ä½¿ç”¨ `set()` å»é‡ï¼Œé¿å…é‡å¤çš„ `hash_code`

3. **æ•°æ®ä¸€è‡´æ€§**:
   - JSON æ–‡ä»¶ä¸­çš„ `source_id` æ˜¯å®Œæ•´çš„ï¼ˆæ‰€æœ‰ `hash_code`ï¼‰
   - MySQL ä¸­çš„ `source_id` æ˜¯æˆªæ–­çš„ï¼ˆæœ€å¤š5ä¸ª `hash_code`ï¼‰

---

## ğŸ“ å…³é”®æ–‡ä»¶è¯´æ˜

### æ„å»ºé˜¶æ®µæ–‡ä»¶

| æ–‡ä»¶ | åŠŸèƒ½ | è¾“å…¥ | è¾“å‡º |
|------|------|------|------|
| `law_data_chunk.py` | æ–‡æœ¬åˆ†å— | æ³•å¾‹æ–‡æ¡£JSON | `*_chunk.json` |
| `GraphExtraction/law_extract_graphrag.py` | å®ä½“å…³ç³»æå– | Chunk JSON | `entity.jsonl`, `relation.jsonl` |
| `build_law_graph.py` | å±‚æ¬¡èšç±»æ„å»º | `entity.jsonl`, `relation.jsonl` | `all_entities.json`, `generate_relations.json`, `community.json` |
| `database_utils.py` | æ•°æ®åº“æ“ä½œ | JSONæ–‡ä»¶ | Milvuså‘é‡åº“ + MySQLè¡¨ |

### æŸ¥è¯¢é˜¶æ®µæ–‡ä»¶

| æ–‡ä»¶ | åŠŸèƒ½ | è¾“å…¥ | è¾“å‡º |
|------|------|------|------|
| `query_law_graph_apikey.py` | çŸ¥è¯†å›¾è°±æŸ¥è¯¢ | æŸ¥è¯¢é—®é¢˜ | LLMç”Ÿæˆçš„å›ç­” |
| `database_utils.py` | æ•°æ®åº“æŸ¥è¯¢å‡½æ•° | æŸ¥è¯¢å‚æ•° | å®ä½“/å…³ç³»/ç¤¾åŒºä¿¡æ¯ |

### æ ¸å¿ƒå‡½æ•°

**å‘é‡æ£€ç´¢**:
- `database_utils.py::search_vector_search()` - Milvuså‘é‡æ£€ç´¢

**MySQLæŸ¥è¯¢**:
- `database_utils.py::find_tree_root()` - æŸ¥æ‰¾å®ä½“åˆ°æ ¹èŠ‚ç‚¹çš„è·¯å¾„
- `database_utils.py::search_nodes_link()` - æŸ¥æ‰¾ä¸¤ä¸ªèŠ‚ç‚¹ä¹‹é—´çš„å…³ç³»
- `database_utils.py::search_community()` - æŸ¥æ‰¾ç¤¾åŒºä¿¡æ¯
- `database_utils.py::get_text_units()` - æå–æ–‡æœ¬å•å…ƒ

**æŸ¥è¯¢æµç¨‹**:
- `query_law_graph_apikey.py::get_reasoning_chain()` - æ„å»ºæ¨ç†è·¯å¾„
- `query_law_graph_apikey.py::get_aggregation_description()` - èšåˆç¤¾åŒºä¿¡æ¯
- `query_law_graph_apikey.py::query_law_graph()` - å®Œæ•´æŸ¥è¯¢æµç¨‹

---

## ğŸ”„ å®Œæ•´æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ³•å¾‹æ–‡æ¡£JSON   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  law_data_chunk  â”‚ æ–‡æœ¬åˆ†å—
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  *_chunk.json   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ law_extract_graphrag.py     â”‚ å®ä½“å…³ç³»æå–ï¼ˆvLLMï¼‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ entity.jsonl    â”‚  â”‚ relation.jsonl  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                    â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  build_law_graph.py   â”‚ å±‚æ¬¡èšç±»
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                       â”‚
         â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Milvuså‘é‡åº“  â”‚    â”‚   MySQLæ•°æ®åº“    â”‚
â”‚  (è¯­ä¹‰æ£€ç´¢)     â”‚    â”‚  (ç»“æ„åŒ–æŸ¥è¯¢)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ query_law_graph.py   â”‚ æŸ¥è¯¢æµç¨‹
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   LLMç”Ÿæˆæœ€ç»ˆå›ç­”     â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ’¡ å…³é”®è®¾è®¡ç†å¿µ

1. **åŒé‡å­˜å‚¨æ¶æ„**:
   - **Milvusï¼ˆå‘é‡åº“ï¼‰**: å¿«é€Ÿè¯­ä¹‰æ£€ç´¢ï¼Œæ”¯æŒç›¸ä¼¼åº¦æœç´¢
   - **MySQLï¼ˆå…³ç³»åº“ï¼‰**: ç»“æ„åŒ–æŸ¥è¯¢ï¼Œæ”¯æŒè·¯å¾„æŸ¥æ‰¾ã€å…³ç³»æŸ¥è¯¢

2. **å±‚æ¬¡åŒ–ç»“æ„**:
   - åŸå§‹èŠ‚ç‚¹ï¼ˆlevel=0ï¼‰: ç›´æ¥ä»æ–‡æœ¬æå–çš„å®ä½“
   - èšåˆèŠ‚ç‚¹ï¼ˆlevel>0ï¼‰: é€šè¿‡èšç±»ç”Ÿæˆçš„æ›´é«˜å±‚æ¬¡æ¦‚å¿µ
   - æ”¯æŒå¤šå±‚çº§æ£€ç´¢å’Œæ¨ç†

3. **å¤šæºä¿¡æ¯èåˆ**:
   - å®ä½“ä¿¡æ¯ï¼ˆç›´æ¥åŒ¹é…ï¼‰
   - æ¨ç†è·¯å¾„ï¼ˆå®ä½“é—´å…³ç³»ï¼‰
   - ç¤¾åŒºèšåˆï¼ˆé«˜å±‚æ¬¡æ¦‚å¿µï¼‰
   - åŸå§‹æ–‡æœ¬ï¼ˆè¯æ®æ”¯æŒï¼‰

4. **å¯æ‰©å±•æ€§**:
   - æ”¯æŒæ‰¹é‡å¤„ç†å¤šä¸ªchunkæ–‡ä»¶
   - æ”¯æŒå¢é‡æ›´æ–°ï¼ˆé€šè¿‡hash_codeå»é‡ï¼‰
   - æ”¯æŒè‡ªå®šä¹‰LLMå’ŒåµŒå…¥æ¨¡å‹

---

## ğŸš€ ä½¿ç”¨ç¤ºä¾‹

### æ„å»ºçŸ¥è¯†å›¾è°±
```bash
# 1. æ–‡æœ¬åˆ†å—
python law_data_chunk.py

# 2. æå–å®ä½“å’Œå…³ç³»
python GraphExtraction/law_extract_graphrag.py

# 3. æ„å»ºå±‚æ¬¡å›¾è°±
python build_law_graph.py -p law_kg_output_v2
```

### æŸ¥è¯¢çŸ¥è¯†å›¾è°±
```bash
# å•æ¡æŸ¥è¯¢
python query_law_graph_apikey.py \
  -p law_kg_output_v2 \
  -q "ä»€ä¹ˆæ˜¯åŠ³åŠ¨åˆåŒï¼Ÿ" \
  --chunks datasets/chunks/law_test_chunk_v2.json

# æ‰¹é‡æŸ¥è¯¢
python query_law_graph_apikey.py \
  -p law_kg_output_v2 \
  --input-json queries.json \
  --output-json results.json
```

---

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **å†…å­˜ç®¡ç†**: 
   - vLLMæ¨¡å‹éœ€è¦å¤§é‡GPUå†…å­˜ï¼Œæ³¨æ„é…ç½® `gpu_memory_utilization` å’Œ `max_model_len`

2. **æ•°æ®ä¸€è‡´æ€§**:
   - ç¡®ä¿Milvuså’ŒMySQLçš„æ•°æ®åŒæ­¥
   - ä½¿ç”¨ç›¸åŒçš„ `working_dir` ä½œä¸ºæ•°æ®æº

3. **æ€§èƒ½ä¼˜åŒ–**:
   - å‘é‡æ£€ç´¢ä½¿ç”¨Milvusçš„ç´¢å¼•ï¼ˆIVF_FLATï¼‰
   - MySQLæŸ¥è¯¢ä½¿ç”¨ç´¢å¼•å­—æ®µï¼ˆentity_name, src_tgtç­‰ï¼‰
   - æ‰¹é‡æ’å…¥ä½¿ç”¨ `executemany` æé«˜æ•ˆç‡

4. **é”™è¯¯å¤„ç†**:
   - æ•°æ®åº“æ“ä½œæœ‰è¶…æ—¶è®¾ç½®ï¼Œé¿å…é•¿æ—¶é—´é˜»å¡
   - å‘é‡åº“å’ŒMySQLæ“ä½œéƒ½æœ‰å¼‚å¸¸æ•è·ï¼Œå¤±è´¥æ—¶ç»§ç»­æ‰§è¡Œ

